 select distinct issue_d,
        sum(loan_amnt) over (partition by issue_d) suma,
        avg(loan_amnt) over (partition by issue_d) avg, 
        stddev(loan_amnt) over (partition by issue_d) stddev, 
        min(loan_amnt) over (partition by issue_d) min, 
        max(loan_amnt) over (partition by issue_d) max, 
        count(*) (partition by issue_d) count 
 from loanstats 
 order by issue_d;
+------------+-----------+------------+-----------+------+-------+-------+
| issue_d    | suma      | avg        | stddev    | min  | max   | count |
+------------+-----------+------------+-----------+------+-------+-------+
| 2007-06-01 |     91850 |  3827.0833 | 2433.3289 | 1000 | 10500 |    24 |
| 2007-07-01 |    348325 |  5528.9683 | 4218.4360 | 1000 | 25000 |    63 |
| 2007-08-01 |    515300 |  6963.5135 | 5402.4241 | 1000 | 25000 |    74 |
| 2007-09-01 |    372950 |  7036.7925 | 4400.3286 |  500 | 20000 |    53 |
| 2007-10-01 |    753225 |  7173.5714 | 4726.3721 |  500 | 25000 |   105 |
| 2007-11-01 |   1008650 |  9005.8036 | 6666.6690 |  500 | 25000 |   112 |
| 2007-12-01 |   1887175 | 10971.9477 | 7017.9459 |  600 | 25000 |   172 |
| 2008-01-01 |   2926000 |  9593.4426 | 6370.5127 |  500 | 25000 |   305 |
| 2008-02-01 |   2959225 |  9670.6699 | 5857.1052 |  600 | 25000 |   306 |
| 2008-03-01 |   4150050 | 10323.5075 | 6333.4629 |  500 | 25000 |   402 |
| 2008-04-01 |   2433875 |  9397.2008 | 5771.4147 |  500 | 25000 |   259 |
| 2008-05-01 |    628900 |  5468.6957 | 2094.4903 | 1000 | 10000 |   115 |
| 2008-06-01 |    660175 |  5323.9919 | 2051.7926 | 1000 |  7500 |   124 |
| 2008-07-01 |    856475 |  6074.2908 | 2949.4695 | 1000 | 15000 |   141 |
| 2008-08-01 |    592450 |  5924.5000 | 2726.8411 | 1500 | 15000 |   100 |
| 2008-09-01 |    317675 |  5573.2456 | 2028.8860 | 1000 |  7500 |    57 |
| 2008-10-01 |    962550 |  7889.7541 | 5151.2769 | 1000 | 25000 |   122 |
| 2008-11-01 |   2064900 |  9879.9043 | 6399.8129 | 1000 | 25000 |   209 |
| 2008-12-01 |   2566975 | 10146.1462 | 5850.0095 | 1000 | 25000 |   253 |
| 2009-01-01 |   2470125 |  9182.6208 | 4324.3268 | 1000 | 19400 |   269 |
| 2009-02-01 |   2714925 |  8989.8179 | 5145.9914 | 1000 | 25000 |   302 |
| 2009-03-01 |   3061300 |  9448.4568 | 5086.9748 | 1000 | 25000 |   324 |
| 2009-04-01 |   3079475 |  9247.6727 | 5756.3009 | 1000 | 25000 |   333 |
| 2009-05-01 |   3443300 |  9591.3649 | 5785.2250 | 1000 | 25000 |   359 |
| 2009-06-01 |   3592300 |  8848.0296 | 5650.2637 | 1000 | 25000 |   406 |
| 2009-07-01 |   3876150 |  9431.0219 | 5947.2418 | 1000 | 25000 |   411 |
| 2009-08-01 |   4318650 |  9683.0717 | 5628.1368 | 1000 | 25000 |   446 |
| 2009-09-01 |   5107225 | 10073.4221 | 5720.5013 | 1000 | 20000 |   507 |
| 2009-10-01 |   6289450 | 10412.9967 | 6715.3859 | 1000 | 25000 |   604 |
| 2009-11-01 |   6848875 | 10345.7326 | 6384.4656 | 1000 | 25000 |   662 |
| 2009-12-01 |   7126475 | 10830.5091 | 6841.3796 | 1000 | 25000 |   658 |
| 2010-01-01 |   7385950 | 11157.0242 | 6617.7836 | 1000 | 25000 |   662 |
| 2010-02-01 |   7460000 | 10938.4164 | 6552.3575 | 1000 | 25000 |   682 |
| 2010-03-01 |   8664750 | 10464.6739 | 6512.0120 | 1000 | 25000 |   828 |
| 2010-04-01 |   9510575 | 10428.2621 | 6312.9321 | 1000 | 25000 |   912 |
| 2010-05-01 |  10608150 | 10726.1375 | 6824.5154 | 1000 | 25000 |   989 |
| 2010-06-01 |  11169550 | 10108.1900 | 6521.9031 | 1000 | 25000 |  1105 |
| 2010-07-01 |  11936500 |  9914.0365 | 6430.6194 | 1000 | 25000 |  1204 |
| 2010-08-01 |  12101875 | 10299.4681 | 6623.8825 | 1000 | 25000 |  1175 |
| 2010-09-01 |  12252600 | 10304.9622 | 6637.8175 | 1000 | 25000 |  1189 |
| 2010-10-01 |  13132125 | 10659.1924 | 6656.1426 | 1000 | 25000 |  1232 |
| 2010-11-01 |  13481475 | 11014.2770 | 6813.1251 | 1000 | 25000 |  1224 |
| 2010-12-01 |  14289000 | 10703.3708 | 6510.6641 | 1000 | 25000 |  1335 |
| 2011-01-01 |  14824575 | 10742.4457 | 6328.0544 | 1000 | 25000 |  1380 |
| 2011-02-01 |  14601275 | 11249.0562 | 7050.8195 | 1000 | 35000 |  1298 |
| 2011-03-01 |  16567325 | 11441.5228 | 7885.5078 | 1000 | 35000 |  1448 |
| 2011-04-01 |  17542075 | 11223.3365 | 8103.6429 | 1000 | 35000 |  1563 |
| 2011-05-01 |  19327950 | 11342.6937 | 7914.6920 | 1000 | 35000 |  1704 |
| 2011-06-01 |  20940200 | 11411.5531 | 8388.5842 | 1000 | 35000 |  1835 |
| 2011-07-01 |  21337600 | 11380.0533 | 7984.3214 | 1000 | 35000 |  1875 |
| 2011-08-01 |  23247525 | 12020.4369 | 8336.6754 | 1000 | 35000 |  1934 |
| 2011-09-01 |  25837650 | 12500.0726 | 8706.6820 | 1000 | 35000 |  2067 |
| 2011-10-01 |  27482550 | 12975.7082 | 8692.6058 | 1000 | 35000 |  2118 |
| 2011-11-01 |  28332600 | 12693.8172 | 8542.1176 | 1000 | 35000 |  2232 |
| 2011-12-01 |  31642500 | 13957.8738 | 8100.0513 | 1000 | 35000 |  2267 |
| 2012-01-01 |  34220475 | 13151.6045 | 8068.1552 | 1000 | 35000 |  2602 |
| 2012-02-01 |  36058175 | 14085.2246 | 8230.9860 | 1000 | 35000 |  2560 |
| 2012-03-01 |  39536300 | 13567.7076 | 8410.1791 | 1000 | 35000 |  2914 |
| 2012-04-01 |  42051125 | 13018.9241 | 8174.2556 | 1000 | 35000 |  3230 |
| 2012-05-01 |  45090825 | 13262.0074 | 8193.1118 | 1000 | 35000 |  3400 |
| 2012-06-01 |  50224275 | 13158.0495 | 8230.2013 | 1000 | 35000 |  3817 |
| 2012-07-01 |  60294525 | 13031.0190 | 7885.5974 | 1000 | 35000 |  4627 |
| 2012-08-01 |  70078650 | 12932.0262 | 7860.7457 | 1000 | 35000 |  5419 |
| 2012-09-01 |  77027750 | 12654.4685 | 7504.8706 | 1000 | 35000 |  6087 |
| 2012-10-01 |  82042125 | 13099.4931 | 7805.7555 | 1000 | 35000 |  6263 |
| 2012-11-01 |  87696350 | 13741.2018 | 8125.6513 | 1000 | 35000 |  6382 |
| 2012-12-01 |  94090450 | 15511.1194 | 8464.2947 | 1000 | 35000 |  6066 |
| 2013-01-01 | 105074375 | 15290.2175 | 7991.3911 | 1000 | 35000 |  6872 |
| 2013-02-01 | 120171375 | 15893.5822 | 8152.1978 | 1000 | 35000 |  7561 |
| 2013-03-01 | 127643500 | 15428.9254 | 8244.5557 | 1000 | 35000 |  8273 |
| 2013-04-01 | 140125775 | 14876.9270 | 8089.2201 | 1000 | 35000 |  9419 |
| 2013-05-01 | 148036475 | 14303.0411 | 7900.0334 | 1000 | 35000 | 10350 |
| 2013-06-01 | 158063375 | 14502.5576 | 8057.9172 | 1000 | 35000 | 10899 |
| 2013-07-01 | 170776825 | 14338.9442 | 8002.3679 | 1000 | 35000 | 11910 |
| 2013-08-01 | 180032675 | 14204.8820 | 8053.0593 | 1000 | 35000 | 12674 |
| 2013-09-01 | 187911125 | 14469.1711 | 7994.9599 | 1000 | 35000 | 12987 |
| 2013-10-01 | 204771925 | 14493.0232 | 7926.1870 | 1000 | 35000 | 14129 |
| 2013-11-01 | 215992725 | 14673.4188 | 8172.7039 | 1000 | 35000 | 14720 |
| 2013-12-01 | 224165125 | 14924.4424 | 8386.0759 | 1000 | 35000 | 15020 |
+------------+-----------+------------+-----------+------+-------+-------+
79 rows in set (12 min 49.196 sec)

select distinct * 
from (select issue_d,
             sum(loan_amnt) over (partition by issue_d) suma,
             avg(loan_amnt) over (partition by issue_d) avg, 
             stddev(loan_amnt) over (partition by issue_d) stddev, 
             min(loan_amnt) over (partition by issue_d) min, 
             max(loan_amnt) over (partition by issue_d) max, 
             count(*) over (partition by issue_d) count 
      from loanstats ) t 
order by t.issue_d;
+------------+-----------+------------+-----------+------+-------+-------+
| issue_d    | suma      | avg        | stddev    | min  | max   | count |
+------------+-----------+------------+-----------+------+-------+-------+
| 2007-06-01 |     91850 |  3827.0833 | 2433.3289 | 1000 | 10500 |    24 |
| 2007-07-01 |    348325 |  5528.9683 | 4218.4360 | 1000 | 25000 |    63 |
| 2007-08-01 |    515300 |  6963.5135 | 5402.4241 | 1000 | 25000 |    74 |
| 2007-09-01 |    372950 |  7036.7925 | 4400.3286 |  500 | 20000 |    53 |
| 2007-10-01 |    753225 |  7173.5714 | 4726.3721 |  500 | 25000 |   105 |
| 2007-11-01 |   1008650 |  9005.8036 | 6666.6690 |  500 | 25000 |   112 |
| 2007-12-01 |   1887175 | 10971.9477 | 7017.9459 |  600 | 25000 |   172 |
| 2008-01-01 |   2926000 |  9593.4426 | 6370.5127 |  500 | 25000 |   305 |
| 2008-02-01 |   2959225 |  9670.6699 | 5857.1052 |  600 | 25000 |   306 |
| 2008-03-01 |   4150050 | 10323.5075 | 6333.4629 |  500 | 25000 |   402 |
| 2008-04-01 |   2433875 |  9397.2008 | 5771.4147 |  500 | 25000 |   259 |
| 2008-05-01 |    628900 |  5468.6957 | 2094.4903 | 1000 | 10000 |   115 |
| 2008-06-01 |    660175 |  5323.9919 | 2051.7926 | 1000 |  7500 |   124 |
| 2008-07-01 |    856475 |  6074.2908 | 2949.4695 | 1000 | 15000 |   141 |
| 2008-08-01 |    592450 |  5924.5000 | 2726.8411 | 1500 | 15000 |   100 |
| 2008-09-01 |    317675 |  5573.2456 | 2028.8860 | 1000 |  7500 |    57 |
| 2008-10-01 |    962550 |  7889.7541 | 5151.2769 | 1000 | 25000 |   122 |
| 2008-11-01 |   2064900 |  9879.9043 | 6399.8129 | 1000 | 25000 |   209 |
| 2008-12-01 |   2566975 | 10146.1462 | 5850.0095 | 1000 | 25000 |   253 |
| 2009-01-01 |   2470125 |  9182.6208 | 4324.3268 | 1000 | 19400 |   269 |
| 2009-02-01 |   2714925 |  8989.8179 | 5145.9914 | 1000 | 25000 |   302 |
| 2009-03-01 |   3061300 |  9448.4568 | 5086.9748 | 1000 | 25000 |   324 |
| 2009-04-01 |   3079475 |  9247.6727 | 5756.3009 | 1000 | 25000 |   333 |
| 2009-05-01 |   3443300 |  9591.3649 | 5785.2250 | 1000 | 25000 |   359 |
| 2009-06-01 |   3592300 |  8848.0296 | 5650.2637 | 1000 | 25000 |   406 |
| 2009-07-01 |   3876150 |  9431.0219 | 5947.2418 | 1000 | 25000 |   411 |
| 2009-08-01 |   4318650 |  9683.0717 | 5628.1368 | 1000 | 25000 |   446 |
| 2009-09-01 |   5107225 | 10073.4221 | 5720.5013 | 1000 | 20000 |   507 |
| 2009-10-01 |   6289450 | 10412.9967 | 6715.3859 | 1000 | 25000 |   604 |
| 2009-11-01 |   6848875 | 10345.7326 | 6384.4656 | 1000 | 25000 |   662 |
| 2009-12-01 |   7126475 | 10830.5091 | 6841.3796 | 1000 | 25000 |   658 |
| 2010-01-01 |   7385950 | 11157.0242 | 6617.7836 | 1000 | 25000 |   662 |
| 2010-02-01 |   7460000 | 10938.4164 | 6552.3575 | 1000 | 25000 |   682 |
| 2010-03-01 |   8664750 | 10464.6739 | 6512.0120 | 1000 | 25000 |   828 |
| 2010-04-01 |   9510575 | 10428.2621 | 6312.9321 | 1000 | 25000 |   912 |
| 2010-05-01 |  10608150 | 10726.1375 | 6824.5154 | 1000 | 25000 |   989 |
| 2010-06-01 |  11169550 | 10108.1900 | 6521.9031 | 1000 | 25000 |  1105 |
| 2010-07-01 |  11936500 |  9914.0365 | 6430.6194 | 1000 | 25000 |  1204 |
| 2010-08-01 |  12101875 | 10299.4681 | 6623.8825 | 1000 | 25000 |  1175 |
| 2010-09-01 |  12252600 | 10304.9622 | 6637.8175 | 1000 | 25000 |  1189 |
| 2010-10-01 |  13132125 | 10659.1924 | 6656.1426 | 1000 | 25000 |  1232 |
| 2010-11-01 |  13481475 | 11014.2770 | 6813.1251 | 1000 | 25000 |  1224 |
| 2010-12-01 |  14289000 | 10703.3708 | 6510.6641 | 1000 | 25000 |  1335 |
| 2011-01-01 |  14824575 | 10742.4457 | 6328.0544 | 1000 | 25000 |  1380 |
| 2011-02-01 |  14601275 | 11249.0562 | 7050.8195 | 1000 | 35000 |  1298 |
| 2011-03-01 |  16567325 | 11441.5228 | 7885.5078 | 1000 | 35000 |  1448 |
| 2011-04-01 |  17542075 | 11223.3365 | 8103.6429 | 1000 | 35000 |  1563 |
| 2011-05-01 |  19327950 | 11342.6937 | 7914.6920 | 1000 | 35000 |  1704 |
| 2011-06-01 |  20940200 | 11411.5531 | 8388.5842 | 1000 | 35000 |  1835 |
| 2011-07-01 |  21337600 | 11380.0533 | 7984.3214 | 1000 | 35000 |  1875 |
| 2011-08-01 |  23247525 | 12020.4369 | 8336.6754 | 1000 | 35000 |  1934 |
| 2011-09-01 |  25837650 | 12500.0726 | 8706.6820 | 1000 | 35000 |  2067 |
| 2011-10-01 |  27482550 | 12975.7082 | 8692.6058 | 1000 | 35000 |  2118 |
| 2011-11-01 |  28332600 | 12693.8172 | 8542.1176 | 1000 | 35000 |  2232 |
| 2011-12-01 |  31642500 | 13957.8738 | 8100.0513 | 1000 | 35000 |  2267 |
| 2012-01-01 |  34220475 | 13151.6045 | 8068.1552 | 1000 | 35000 |  2602 |
| 2012-02-01 |  36058175 | 14085.2246 | 8230.9860 | 1000 | 35000 |  2560 |
| 2012-03-01 |  39536300 | 13567.7076 | 8410.1791 | 1000 | 35000 |  2914 |
| 2012-04-01 |  42051125 | 13018.9241 | 8174.2556 | 1000 | 35000 |  3230 |
| 2012-05-01 |  45090825 | 13262.0074 | 8193.1118 | 1000 | 35000 |  3400 |
| 2012-06-01 |  50224275 | 13158.0495 | 8230.2013 | 1000 | 35000 |  3817 |
| 2012-07-01 |  60294525 | 13031.0190 | 7885.5974 | 1000 | 35000 |  4627 |
| 2012-08-01 |  70078650 | 12932.0262 | 7860.7457 | 1000 | 35000 |  5419 |
| 2012-09-01 |  77027750 | 12654.4685 | 7504.8706 | 1000 | 35000 |  6087 |
| 2012-10-01 |  82042125 | 13099.4931 | 7805.7555 | 1000 | 35000 |  6263 |
| 2012-11-01 |  87696350 | 13741.2018 | 8125.6513 | 1000 | 35000 |  6382 |
| 2012-12-01 |  94090450 | 15511.1194 | 8464.2947 | 1000 | 35000 |  6066 |
| 2013-01-01 | 105074375 | 15290.2175 | 7991.3911 | 1000 | 35000 |  6872 |
| 2013-02-01 | 120171375 | 15893.5822 | 8152.1978 | 1000 | 35000 |  7561 |
| 2013-03-01 | 127643500 | 15428.9254 | 8244.5557 | 1000 | 35000 |  8273 |
| 2013-04-01 | 140125775 | 14876.9270 | 8089.2201 | 1000 | 35000 |  9419 |
| 2013-05-01 | 148036475 | 14303.0411 | 7900.0334 | 1000 | 35000 | 10350 |
| 2013-06-01 | 158063375 | 14502.5576 | 8057.9172 | 1000 | 35000 | 10899 |
| 2013-07-01 | 170776825 | 14338.9442 | 8002.3679 | 1000 | 35000 | 11910 |
| 2013-08-01 | 180032675 | 14204.8820 | 8053.0593 | 1000 | 35000 | 12674 |
| 2013-09-01 | 187911125 | 14469.1711 | 7994.9599 | 1000 | 35000 | 12987 |
| 2013-10-01 | 204771925 | 14493.0232 | 7926.1870 | 1000 | 35000 | 14129 |
| 2013-11-01 | 215992725 | 14673.4188 | 8172.7039 | 1000 | 35000 | 14720 |
| 2013-12-01 | 224165125 | 14924.4424 | 8386.0759 | 1000 | 35000 | 15020 |
+------------+-----------+------------+-----------+------+-------+-------+
79 rows in set (13 min 12.792 sec)
 

select distinct issue_d, avg(loan_amnt) over (partition by issue_d) avg, count(*) over (partition by issue_d) count from loanstats order by issue_d;
+------------+------------+-------+
| issue_d    | avg        | count |
+------------+------------+-------+
| 2007-06-01 |  3827.0833 |    24 |
| 2007-07-01 |  5528.9683 |    63 |
| 2007-08-01 |  6963.5135 |    74 |
| 2007-09-01 |  7036.7925 |    53 |
| 2007-10-01 |  7173.5714 |   105 |
| 2007-11-01 |  9005.8036 |   112 |
| 2007-12-01 | 10971.9477 |   172 |
| 2008-01-01 |  9593.4426 |   305 |
| 2008-02-01 |  9670.6699 |   306 |
| 2008-03-01 | 10323.5075 |   402 |
| 2008-04-01 |  9397.2008 |   259 |
| 2008-05-01 |  5468.6957 |   115 |
| 2008-06-01 |  5323.9919 |   124 |
| 2008-07-01 |  6074.2908 |   141 |
| 2008-08-01 |  5924.5000 |   100 |
| 2008-09-01 |  5573.2456 |    57 |
| 2008-10-01 |  7889.7541 |   122 |
| 2008-11-01 |  9879.9043 |   209 |
| 2008-12-01 | 10146.1462 |   253 |
| 2009-01-01 |  9182.6208 |   269 |
| 2009-02-01 |  8989.8179 |   302 |
| 2009-03-01 |  9448.4568 |   324 |
| 2009-04-01 |  9247.6727 |   333 |
| 2009-05-01 |  9591.3649 |   359 |
| 2009-06-01 |  8848.0296 |   406 |
| 2009-07-01 |  9431.0219 |   411 |
| 2009-08-01 |  9683.0717 |   446 |
| 2009-09-01 | 10073.4221 |   507 |
| 2009-10-01 | 10412.9967 |   604 |
| 2009-11-01 | 10345.7326 |   662 |
| 2009-12-01 | 10830.5091 |   658 |
| 2010-01-01 | 11157.0242 |   662 |
| 2010-02-01 | 10938.4164 |   682 |
| 2010-03-01 | 10464.6739 |   828 |
| 2010-04-01 | 10428.2621 |   912 |
| 2010-05-01 | 10726.1375 |   989 |
| 2010-06-01 | 10108.1900 |  1105 |
| 2010-07-01 |  9914.0365 |  1204 |
| 2010-08-01 | 10299.4681 |  1175 |
| 2010-09-01 | 10304.9622 |  1189 |
| 2010-10-01 | 10659.1924 |  1232 |
| 2010-11-01 | 11014.2770 |  1224 |
| 2010-12-01 | 10703.3708 |  1335 |
| 2011-01-01 | 10742.4457 |  1380 |
| 2011-02-01 | 11249.0562 |  1298 |
| 2011-03-01 | 11441.5228 |  1448 |
| 2011-04-01 | 11223.3365 |  1563 |
| 2011-05-01 | 11342.6937 |  1704 |
| 2011-06-01 | 11411.5531 |  1835 |
| 2011-07-01 | 11380.0533 |  1875 |
| 2011-08-01 | 12020.4369 |  1934 |
| 2011-09-01 | 12500.0726 |  2067 |
| 2011-10-01 | 12975.7082 |  2118 |
| 2011-11-01 | 12693.8172 |  2232 |
| 2011-12-01 | 13957.8738 |  2267 |
| 2012-01-01 | 13151.6045 |  2602 |
| 2012-02-01 | 14085.2246 |  2560 |
| 2012-03-01 | 13567.7076 |  2914 |
| 2012-04-01 | 13018.9241 |  3230 |
| 2012-05-01 | 13262.0074 |  3400 |
| 2012-06-01 | 13158.0495 |  3817 |
| 2012-07-01 | 13031.0190 |  4627 |
| 2012-08-01 | 12932.0262 |  5419 |
| 2012-09-01 | 12654.4685 |  6087 |
| 2012-10-01 | 13099.4931 |  6263 |
| 2012-11-01 | 13741.2018 |  6382 |
| 2012-12-01 | 15511.1194 |  6066 |
| 2013-01-01 | 15290.2175 |  6872 |
| 2013-02-01 | 15893.5822 |  7561 |
| 2013-03-01 | 15428.9254 |  8273 |
| 2013-04-01 | 14876.9270 |  9419 |
| 2013-05-01 | 14303.0411 | 10350 |
| 2013-06-01 | 14502.5576 | 10899 |
| 2013-07-01 | 14338.9442 | 11910 |
| 2013-08-01 | 14204.8820 | 12674 |
| 2013-09-01 | 14469.1711 | 12987 |
| 2013-10-01 | 14493.0232 | 14129 |
| 2013-11-01 | 14673.4188 | 14720 |
| 2013-12-01 | 14924.4424 | 15020 |
+------------+------------+-------+
79 rows in set (0.821 sec)


select issue_d, 
       avg, 
       rank() over (order by avg) rankavg, 
       count 
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by rankavg;
+------------+------------+---------+-------+
| issue_d    | avg        | rankavg | count |
+------------+------------+---------+-------+
| 2007-06-01 |  3827.0833 |       1 |    24 |
| 2008-06-01 |  5323.9919 |       2 |   124 |
| 2008-05-01 |  5468.6957 |       3 |   115 |
| 2007-07-01 |  5528.9683 |       4 |    63 |
| 2008-09-01 |  5573.2456 |       5 |    57 |
| 2008-08-01 |  5924.5000 |       6 |   100 |
| 2008-07-01 |  6074.2908 |       7 |   141 |
| 2007-08-01 |  6963.5135 |       8 |    74 |
| 2007-09-01 |  7036.7925 |       9 |    53 |
| 2007-10-01 |  7173.5714 |      10 |   105 |
| 2008-10-01 |  7889.7541 |      11 |   122 |
| 2009-06-01 |  8848.0296 |      12 |   406 |
| 2009-02-01 |  8989.8179 |      13 |   302 |
| 2007-11-01 |  9005.8036 |      14 |   112 |
| 2009-01-01 |  9182.6208 |      15 |   269 |
| 2009-04-01 |  9247.6727 |      16 |   333 |
| 2008-04-01 |  9397.2008 |      17 |   259 |
| 2009-07-01 |  9431.0219 |      18 |   411 |
| 2009-03-01 |  9448.4568 |      19 |   324 |
| 2009-05-01 |  9591.3649 |      20 |   359 |
| 2008-01-01 |  9593.4426 |      21 |   305 |
| 2008-02-01 |  9670.6699 |      22 |   306 |
| 2009-08-01 |  9683.0717 |      23 |   446 |
| 2008-11-01 |  9879.9043 |      24 |   209 |
| 2010-07-01 |  9914.0365 |      25 |  1204 |
| 2009-09-01 | 10073.4221 |      26 |   507 |
| 2010-06-01 | 10108.1900 |      27 |  1105 |
| 2008-12-01 | 10146.1462 |      28 |   253 |
| 2010-08-01 | 10299.4681 |      29 |  1175 |
| 2010-09-01 | 10304.9622 |      30 |  1189 |
| 2008-03-01 | 10323.5075 |      31 |   402 |
| 2009-11-01 | 10345.7326 |      32 |   662 |
| 2009-10-01 | 10412.9967 |      33 |   604 |
| 2010-04-01 | 10428.2621 |      34 |   912 |
| 2010-03-01 | 10464.6739 |      35 |   828 |
| 2010-10-01 | 10659.1924 |      36 |  1232 |
| 2010-12-01 | 10703.3708 |      37 |  1335 |
| 2010-05-01 | 10726.1375 |      38 |   989 |
| 2011-01-01 | 10742.4457 |      39 |  1380 |
| 2009-12-01 | 10830.5091 |      40 |   658 |
| 2010-02-01 | 10938.4164 |      41 |   682 |
| 2007-12-01 | 10971.9477 |      42 |   172 |
| 2010-11-01 | 11014.2770 |      43 |  1224 |
| 2010-01-01 | 11157.0242 |      44 |   662 |
| 2011-04-01 | 11223.3365 |      45 |  1563 |
| 2011-02-01 | 11249.0562 |      46 |  1298 |
| 2011-05-01 | 11342.6937 |      47 |  1704 |
| 2011-07-01 | 11380.0533 |      48 |  1875 |
| 2011-06-01 | 11411.5531 |      49 |  1835 |
| 2011-03-01 | 11441.5228 |      50 |  1448 |
| 2011-08-01 | 12020.4369 |      51 |  1934 |
| 2011-09-01 | 12500.0726 |      52 |  2067 |
| 2012-09-01 | 12654.4685 |      53 |  6087 |
| 2011-11-01 | 12693.8172 |      54 |  2232 |
| 2012-08-01 | 12932.0262 |      55 |  5419 |
| 2011-10-01 | 12975.7082 |      56 |  2118 |
| 2012-04-01 | 13018.9241 |      57 |  3230 |
| 2012-07-01 | 13031.0190 |      58 |  4627 |
| 2012-10-01 | 13099.4931 |      59 |  6263 |
| 2012-01-01 | 13151.6045 |      60 |  2602 |
| 2012-06-01 | 13158.0495 |      61 |  3817 |
| 2012-05-01 | 13262.0074 |      62 |  3400 |
| 2012-03-01 | 13567.7076 |      63 |  2914 |
| 2012-11-01 | 13741.2018 |      64 |  6382 |
| 2011-12-01 | 13957.8738 |      65 |  2267 |
| 2012-02-01 | 14085.2246 |      66 |  2560 |
| 2013-08-01 | 14204.8820 |      67 | 12674 |
| 2013-05-01 | 14303.0411 |      68 | 10350 |
| 2013-07-01 | 14338.9442 |      69 | 11910 |
| 2013-09-01 | 14469.1711 |      70 | 12987 |
| 2013-10-01 | 14493.0232 |      71 | 14129 |
| 2013-06-01 | 14502.5576 |      72 | 10899 |
| 2013-11-01 | 14673.4188 |      73 | 14720 |
| 2013-04-01 | 14876.9270 |      74 |  9419 |
| 2013-12-01 | 14924.4424 |      75 | 15020 |
| 2013-01-01 | 15290.2175 |      76 |  6872 |
| 2013-03-01 | 15428.9254 |      77 |  8273 |
| 2012-12-01 | 15511.1194 |      78 |  6066 |
| 2013-02-01 | 15893.5822 |      79 |  7561 |
+------------+------------+---------+-------+
79 rows in set (1.331 sec)


select distinct issue_d, 
       avg, 
       rank() over (order by avg) rankavg, 
       count 
from (select * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by rankavg;
+------------+------------+---------+-------+
| issue_d    | avg        | rankavg | count |
+------------+------------+---------+-------+
| 2007-06-01 |  3827.0833 |       1 |    24 |
| 2008-06-01 |  5323.9919 |      25 |   124 |
| 2008-05-01 |  5468.6957 |     149 |   115 |
| 2007-07-01 |  5528.9683 |     264 |    63 |
| 2008-09-01 |  5573.2456 |     327 |    57 |
| 2008-08-01 |  5924.5000 |     384 |   100 |
| 2008-07-01 |  6074.2908 |     484 |   141 |
| 2007-08-01 |  6963.5135 |     625 |    74 |
| 2007-09-01 |  7036.7925 |     699 |    53 |
| 2007-10-01 |  7173.5714 |     752 |   105 |
| 2008-10-01 |  7889.7541 |     857 |   122 |
| 2009-06-01 |  8848.0296 |     979 |   406 |
| 2009-02-01 |  8989.8179 |    1385 |   302 |
| 2007-11-01 |  9005.8036 |    1687 |   112 |
| 2009-01-01 |  9182.6208 |    1799 |   269 |
| 2009-04-01 |  9247.6727 |    2068 |   333 |
| 2008-04-01 |  9397.2008 |    2401 |   259 |
| 2009-07-01 |  9431.0219 |    2660 |   411 |
| 2009-03-01 |  9448.4568 |    3071 |   324 |
| 2009-05-01 |  9591.3649 |    3395 |   359 |
| 2008-01-01 |  9593.4426 |    3754 |   305 |
| 2008-02-01 |  9670.6699 |    4059 |   306 |
| 2009-08-01 |  9683.0717 |    4365 |   446 |
| 2008-11-01 |  9879.9043 |    4811 |   209 |
| 2010-07-01 |  9914.0365 |    5020 |  1204 |
| 2009-09-01 | 10073.4221 |    6224 |   507 |
| 2010-06-01 | 10108.1900 |    6731 |  1105 |
| 2008-12-01 | 10146.1462 |    7836 |   253 |
| 2010-08-01 | 10299.4681 |    8089 |  1175 |
| 2010-09-01 | 10304.9622 |    9264 |  1189 |
| 2008-03-01 | 10323.5075 |   10453 |   402 |
| 2009-11-01 | 10345.7326 |   10855 |   662 |
| 2009-10-01 | 10412.9967 |   11517 |   604 |
| 2010-04-01 | 10428.2621 |   12121 |   912 |
| 2010-03-01 | 10464.6739 |   13033 |   828 |
| 2010-10-01 | 10659.1924 |   13861 |  1232 |
| 2010-12-01 | 10703.3708 |   15093 |  1335 |
| 2010-05-01 | 10726.1375 |   16428 |   989 |
| 2011-01-01 | 10742.4457 |   17417 |  1380 |
| 2009-12-01 | 10830.5091 |   18797 |   658 |
| 2010-02-01 | 10938.4164 |   19455 |   682 |
| 2007-12-01 | 10971.9477 |   20137 |   172 |
| 2010-11-01 | 11014.2770 |   20309 |  1224 |
| 2010-01-01 | 11157.0242 |   21533 |   662 |
| 2011-04-01 | 11223.3365 |   22195 |  1563 |
| 2011-02-01 | 11249.0562 |   23758 |  1298 |
| 2011-05-01 | 11342.6937 |   25056 |  1704 |
| 2011-07-01 | 11380.0533 |   26760 |  1875 |
| 2011-06-01 | 11411.5531 |   28635 |  1835 |
| 2011-03-01 | 11441.5228 |   30470 |  1448 |
| 2011-08-01 | 12020.4369 |   31918 |  1934 |
| 2011-09-01 | 12500.0726 |   33852 |  2067 |
| 2012-09-01 | 12654.4685 |   35919 |  6087 |
| 2011-11-01 | 12693.8172 |   42006 |  2232 |
| 2012-08-01 | 12932.0262 |   44238 |  5419 |
| 2011-10-01 | 12975.7082 |   49657 |  2118 |
| 2012-04-01 | 13018.9241 |   51775 |  3230 |
| 2012-07-01 | 13031.0190 |   55005 |  4627 |
| 2012-10-01 | 13099.4931 |   59632 |  6263 |
| 2012-01-01 | 13151.6045 |   65895 |  2602 |
| 2012-06-01 | 13158.0495 |   68497 |  3817 |
| 2012-05-01 | 13262.0074 |   72314 |  3400 |
| 2012-03-01 | 13567.7076 |   75714 |  2914 |
| 2012-11-01 | 13741.2018 |   78628 |  6382 |
| 2011-12-01 | 13957.8738 |   85010 |  2267 |
| 2012-02-01 | 14085.2246 |   87277 |  2560 |
| 2013-08-01 | 14204.8820 |   89837 | 12674 |
| 2013-05-01 | 14303.0411 |  102511 | 10350 |
| 2013-07-01 | 14338.9442 |  112861 | 11910 |
| 2013-09-01 | 14469.1711 |  124771 | 12987 |
| 2013-10-01 | 14493.0232 |  137758 | 14129 |
| 2013-06-01 | 14502.5576 |  151887 | 10899 |
| 2013-11-01 | 14673.4188 |  162786 | 14720 |
| 2013-04-01 | 14876.9270 |  177506 |  9419 |
| 2013-12-01 | 14924.4424 |  186925 | 15020 |
| 2013-01-01 | 15290.2175 |  201945 |  6872 |
| 2013-03-01 | 15428.9254 |  208817 |  8273 |
| 2012-12-01 | 15511.1194 |  217090 |  6066 |
| 2013-02-01 | 15893.5822 |  223156 |  7561 |
+------------+------------+---------+-------+
79 rows in set (1.582 sec)


============================================================================================ 
CUME_DIST

select row_number() over (partition by year(issue_d) order by issue_d) row_in_year, 
       issue_d, 
       avg, 
       count,
       rank() over (order by count) rank_count, 
       percent_rank() over (order by count) percent_rank_count, 
       cume_dist() over (order by count) cume_dist_count
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+-------------+------------+------------+-------+------------+--------------------+-----------------+
| row_in_year | issue_d    | avg        | count | rank_count | percent_rank_count | cume_dist_count |
+-------------+------------+------------+-------+------------+--------------------+-----------------+
|           1 | 2007-06-01 |  3827.0833 |    24 |          1 |       0.0000000000 |    0.0126582278 |
|           2 | 2007-07-01 |  5528.9683 |    63 |          4 |       0.0384615385 |    0.0506329114 |
|           3 | 2007-08-01 |  6963.5135 |    74 |          5 |       0.0512820513 |    0.0632911392 |
|           4 | 2007-09-01 |  7036.7925 |    53 |          2 |       0.0128205128 |    0.0253164557 |
|           5 | 2007-10-01 |  7173.5714 |   105 |          7 |       0.0769230769 |    0.0886075949 |
|           6 | 2007-11-01 |  9005.8036 |   112 |          8 |       0.0897435897 |    0.1012658228 |
|           7 | 2007-12-01 | 10971.9477 |   172 |         13 |       0.1538461538 |    0.1645569620 |
|           1 | 2008-01-01 |  9593.4426 |   305 |         19 |       0.2307692308 |    0.2405063291 |
|           2 | 2008-02-01 |  9670.6699 |   306 |         20 |       0.2435897436 |    0.2531645570 |
|           3 | 2008-03-01 | 10323.5075 |   402 |         24 |       0.2948717949 |    0.3037974684 |
|           4 | 2008-04-01 |  9397.2008 |   259 |         16 |       0.1923076923 |    0.2025316456 |
|           5 | 2008-05-01 |  5468.6957 |   115 |          9 |       0.1025641026 |    0.1139240506 |
|           6 | 2008-06-01 |  5323.9919 |   124 |         11 |       0.1282051282 |    0.1392405063 |
|           7 | 2008-07-01 |  6074.2908 |   141 |         12 |       0.1410256410 |    0.1518987342 |
|           8 | 2008-08-01 |  5924.5000 |   100 |          6 |       0.0641025641 |    0.0759493671 |
|           9 | 2008-09-01 |  5573.2456 |    57 |          3 |       0.0256410256 |    0.0379746835 |
|          10 | 2008-10-01 |  7889.7541 |   122 |         10 |       0.1153846154 |    0.1265822785 |
|          11 | 2008-11-01 |  9879.9043 |   209 |         14 |       0.1666666667 |    0.1772151899 |
|          12 | 2008-12-01 | 10146.1462 |   253 |         15 |       0.1794871795 |    0.1898734177 |
|           1 | 2009-01-01 |  9182.6208 |   269 |         17 |       0.2051282051 |    0.2151898734 |
|           2 | 2009-02-01 |  8989.8179 |   302 |         18 |       0.2179487179 |    0.2278481013 |
|           3 | 2009-03-01 |  9448.4568 |   324 |         21 |       0.2564102564 |    0.2658227848 |
|           4 | 2009-04-01 |  9247.6727 |   333 |         22 |       0.2692307692 |    0.2784810127 |
|           5 | 2009-05-01 |  9591.3649 |   359 |         23 |       0.2820512821 |    0.2911392405 |
|           6 | 2009-06-01 |  8848.0296 |   406 |         25 |       0.3076923077 |    0.3164556962 |
|           7 | 2009-07-01 |  9431.0219 |   411 |         26 |       0.3205128205 |    0.3291139241 |
|           8 | 2009-08-01 |  9683.0717 |   446 |         27 |       0.3333333333 |    0.3417721519 |
|           9 | 2009-09-01 | 10073.4221 |   507 |         28 |       0.3461538462 |    0.3544303797 |
|          10 | 2009-10-01 | 10412.9967 |   604 |         29 |       0.3589743590 |    0.3670886076 |
|          11 | 2009-11-01 | 10345.7326 |   662 |         31 |       0.3846153846 |    0.4050632911 |
|          12 | 2009-12-01 | 10830.5091 |   658 |         30 |       0.3717948718 |    0.3797468354 |
|           1 | 2010-01-01 | 11157.0242 |   662 |         31 |       0.3846153846 |    0.4050632911 |
|           2 | 2010-02-01 | 10938.4164 |   682 |         33 |       0.4102564103 |    0.4177215190 |
|           3 | 2010-03-01 | 10464.6739 |   828 |         34 |       0.4230769231 |    0.4303797468 |
|           4 | 2010-04-01 | 10428.2621 |   912 |         35 |       0.4358974359 |    0.4430379747 |
|           5 | 2010-05-01 | 10726.1375 |   989 |         36 |       0.4487179487 |    0.4556962025 |
|           6 | 2010-06-01 | 10108.1900 |  1105 |         37 |       0.4615384615 |    0.4683544304 |
|           7 | 2010-07-01 |  9914.0365 |  1204 |         40 |       0.5000000000 |    0.5063291139 |
|           8 | 2010-08-01 | 10299.4681 |  1175 |         38 |       0.4743589744 |    0.4810126582 |
|           9 | 2010-09-01 | 10304.9622 |  1189 |         39 |       0.4871794872 |    0.4936708861 |
|          10 | 2010-10-01 | 10659.1924 |  1232 |         42 |       0.5256410256 |    0.5316455696 |
|          11 | 2010-11-01 | 11014.2770 |  1224 |         41 |       0.5128205128 |    0.5189873418 |
|          12 | 2010-12-01 | 10703.3708 |  1335 |         44 |       0.5512820513 |    0.5569620253 |
|           1 | 2011-01-01 | 10742.4457 |  1380 |         45 |       0.5641025641 |    0.5696202532 |
|           2 | 2011-02-01 | 11249.0562 |  1298 |         43 |       0.5384615385 |    0.5443037975 |
|           3 | 2011-03-01 | 11441.5228 |  1448 |         46 |       0.5769230769 |    0.5822784810 |
|           4 | 2011-04-01 | 11223.3365 |  1563 |         47 |       0.5897435897 |    0.5949367089 |
|           5 | 2011-05-01 | 11342.6937 |  1704 |         48 |       0.6025641026 |    0.6075949367 |
|           6 | 2011-06-01 | 11411.5531 |  1835 |         49 |       0.6153846154 |    0.6202531646 |
|           7 | 2011-07-01 | 11380.0533 |  1875 |         50 |       0.6282051282 |    0.6329113924 |
|           8 | 2011-08-01 | 12020.4369 |  1934 |         51 |       0.6410256410 |    0.6455696203 |
|           9 | 2011-09-01 | 12500.0726 |  2067 |         52 |       0.6538461538 |    0.6582278481 |
|          10 | 2011-10-01 | 12975.7082 |  2118 |         53 |       0.6666666667 |    0.6708860759 |
|          11 | 2011-11-01 | 12693.8172 |  2232 |         54 |       0.6794871795 |    0.6835443038 |
|          12 | 2011-12-01 | 13957.8738 |  2267 |         55 |       0.6923076923 |    0.6962025316 |
|           1 | 2012-01-01 | 13151.6045 |  2602 |         57 |       0.7179487179 |    0.7215189873 |
|           2 | 2012-02-01 | 14085.2246 |  2560 |         56 |       0.7051282051 |    0.7088607595 |
|           3 | 2012-03-01 | 13567.7076 |  2914 |         58 |       0.7307692308 |    0.7341772152 |
|           4 | 2012-04-01 | 13018.9241 |  3230 |         59 |       0.7435897436 |    0.7468354430 |
|           5 | 2012-05-01 | 13262.0074 |  3400 |         60 |       0.7564102564 |    0.7594936709 |
|           6 | 2012-06-01 | 13158.0495 |  3817 |         61 |       0.7692307692 |    0.7721518987 |
|           7 | 2012-07-01 | 13031.0190 |  4627 |         62 |       0.7820512821 |    0.7848101266 |
|           8 | 2012-08-01 | 12932.0262 |  5419 |         63 |       0.7948717949 |    0.7974683544 |
|           9 | 2012-09-01 | 12654.4685 |  6087 |         65 |       0.8205128205 |    0.8227848101 |
|          10 | 2012-10-01 | 13099.4931 |  6263 |         66 |       0.8333333333 |    0.8354430380 |
|          11 | 2012-11-01 | 13741.2018 |  6382 |         67 |       0.8461538462 |    0.8481012658 |
|          12 | 2012-12-01 | 15511.1194 |  6066 |         64 |       0.8076923077 |    0.8101265823 |
|           1 | 2013-01-01 | 15290.2175 |  6872 |         68 |       0.8589743590 |    0.8607594937 |
|           2 | 2013-02-01 | 15893.5822 |  7561 |         69 |       0.8717948718 |    0.8734177215 |
|           3 | 2013-03-01 | 15428.9254 |  8273 |         70 |       0.8846153846 |    0.8860759494 |
|           4 | 2013-04-01 | 14876.9270 |  9419 |         71 |       0.8974358974 |    0.8987341772 |
|           5 | 2013-05-01 | 14303.0411 | 10350 |         72 |       0.9102564103 |    0.9113924051 |
|           6 | 2013-06-01 | 14502.5576 | 10899 |         73 |       0.9230769231 |    0.9240506329 |
|           7 | 2013-07-01 | 14338.9442 | 11910 |         74 |       0.9358974359 |    0.9367088608 |
|           8 | 2013-08-01 | 14204.8820 | 12674 |         75 |       0.9487179487 |    0.9493670886 |
|           9 | 2013-09-01 | 14469.1711 | 12987 |         76 |       0.9615384615 |    0.9620253165 |
|          10 | 2013-10-01 | 14493.0232 | 14129 |         77 |       0.9743589744 |    0.9746835443 |
|          11 | 2013-11-01 | 14673.4188 | 14720 |         78 |       0.9871794872 |    0.9873417722 |
|          12 | 2013-12-01 | 14924.4424 | 15020 |         79 |       1.0000000000 |    1.0000000000 |
+-------------+------------+------------+-------+------------+--------------------+-----------------+
79 rows in set (1.357 sec)



============================================================================================ 
DENSE_RANK

select row_number() over (partition by year(issue_d) order by issue_d) row_in_year, 
       issue_d, 
       avg, 
       count,
       rank() over (order by count) rank_count_total, 
       dense_rank() over (order by count) dense_rank_count_total, 
       rank() over (partition by year(issue_d) order by count) rank_count_year
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by count;
+-------------+------------+------------+-------+------------------+------------------------+-----------------+
| row_in_year | issue_d    | avg        | count | rank_count_total | dense_rank_count_total | rank_count_year |
+-------------+------------+------------+-------+------------------+------------------------+-----------------+
|           1 | 2007-06-01 |  3827.0833 |    24 |                1 |                      1 |               1 |
|           4 | 2007-09-01 |  7036.7925 |    53 |                2 |                      2 |               2 |
|           9 | 2008-09-01 |  5573.2456 |    57 |                3 |                      3 |               1 |
|           2 | 2007-07-01 |  5528.9683 |    63 |                4 |                      4 |               3 |
|           3 | 2007-08-01 |  6963.5135 |    74 |                5 |                      5 |               4 |
|           8 | 2008-08-01 |  5924.5000 |   100 |                6 |                      6 |               2 |
|           5 | 2007-10-01 |  7173.5714 |   105 |                7 |                      7 |               5 |
|           6 | 2007-11-01 |  9005.8036 |   112 |                8 |                      8 |               6 |
|           5 | 2008-05-01 |  5468.6957 |   115 |                9 |                      9 |               3 |
|          10 | 2008-10-01 |  7889.7541 |   122 |               10 |                     10 |               4 |
|           6 | 2008-06-01 |  5323.9919 |   124 |               11 |                     11 |               5 |
|           7 | 2008-07-01 |  6074.2908 |   141 |               12 |                     12 |               6 |
|           7 | 2007-12-01 | 10971.9477 |   172 |               13 |                     13 |               7 |
|          11 | 2008-11-01 |  9879.9043 |   209 |               14 |                     14 |               7 |
|          12 | 2008-12-01 | 10146.1462 |   253 |               15 |                     15 |               8 |
|           4 | 2008-04-01 |  9397.2008 |   259 |               16 |                     16 |               9 |
|           1 | 2009-01-01 |  9182.6208 |   269 |               17 |                     17 |               1 |
|           2 | 2009-02-01 |  8989.8179 |   302 |               18 |                     18 |               2 |
|           1 | 2008-01-01 |  9593.4426 |   305 |               19 |                     19 |              10 |
|           2 | 2008-02-01 |  9670.6699 |   306 |               20 |                     20 |              11 |
|           3 | 2009-03-01 |  9448.4568 |   324 |               21 |                     21 |               3 |
|           4 | 2009-04-01 |  9247.6727 |   333 |               22 |                     22 |               4 |
|           5 | 2009-05-01 |  9591.3649 |   359 |               23 |                     23 |               5 |
|           3 | 2008-03-01 | 10323.5075 |   402 |               24 |                     24 |              12 |
|           6 | 2009-06-01 |  8848.0296 |   406 |               25 |                     25 |               6 |
|           7 | 2009-07-01 |  9431.0219 |   411 |               26 |                     26 |               7 |
|           8 | 2009-08-01 |  9683.0717 |   446 |               27 |                     27 |               8 |
|           9 | 2009-09-01 | 10073.4221 |   507 |               28 |                     28 |               9 |
|          10 | 2009-10-01 | 10412.9967 |   604 |               29 |                     29 |              10 |
|          12 | 2009-12-01 | 10830.5091 |   658 |               30 |                     30 |              11 |
|          11 | 2009-11-01 | 10345.7326 |   662 |               31 |                     31 |              12 |
|           1 | 2010-01-01 | 11157.0242 |   662 |               31 |                     31 |               1 |
|           2 | 2010-02-01 | 10938.4164 |   682 |               33 |                     32 |               2 |
|           3 | 2010-03-01 | 10464.6739 |   828 |               34 |                     33 |               3 |
|           4 | 2010-04-01 | 10428.2621 |   912 |               35 |                     34 |               4 |
|           5 | 2010-05-01 | 10726.1375 |   989 |               36 |                     35 |               5 |
|           6 | 2010-06-01 | 10108.1900 |  1105 |               37 |                     36 |               6 |
|           8 | 2010-08-01 | 10299.4681 |  1175 |               38 |                     37 |               7 |
|           9 | 2010-09-01 | 10304.9622 |  1189 |               39 |                     38 |               8 |
|           7 | 2010-07-01 |  9914.0365 |  1204 |               40 |                     39 |               9 |
|          11 | 2010-11-01 | 11014.2770 |  1224 |               41 |                     40 |              10 |
|          10 | 2010-10-01 | 10659.1924 |  1232 |               42 |                     41 |              11 |
|           2 | 2011-02-01 | 11249.0562 |  1298 |               43 |                     42 |               1 |
|          12 | 2010-12-01 | 10703.3708 |  1335 |               44 |                     43 |              12 |
|           1 | 2011-01-01 | 10742.4457 |  1380 |               45 |                     44 |               2 |
|           3 | 2011-03-01 | 11441.5228 |  1448 |               46 |                     45 |               3 |
|           4 | 2011-04-01 | 11223.3365 |  1563 |               47 |                     46 |               4 |
|           5 | 2011-05-01 | 11342.6937 |  1704 |               48 |                     47 |               5 |
|           6 | 2011-06-01 | 11411.5531 |  1835 |               49 |                     48 |               6 |
|           7 | 2011-07-01 | 11380.0533 |  1875 |               50 |                     49 |               7 |
|           8 | 2011-08-01 | 12020.4369 |  1934 |               51 |                     50 |               8 |
|           9 | 2011-09-01 | 12500.0726 |  2067 |               52 |                     51 |               9 |
|          10 | 2011-10-01 | 12975.7082 |  2118 |               53 |                     52 |              10 |
|          11 | 2011-11-01 | 12693.8172 |  2232 |               54 |                     53 |              11 |
|          12 | 2011-12-01 | 13957.8738 |  2267 |               55 |                     54 |              12 |
|           2 | 2012-02-01 | 14085.2246 |  2560 |               56 |                     55 |               1 |
|           1 | 2012-01-01 | 13151.6045 |  2602 |               57 |                     56 |               2 |
|           3 | 2012-03-01 | 13567.7076 |  2914 |               58 |                     57 |               3 |
|           4 | 2012-04-01 | 13018.9241 |  3230 |               59 |                     58 |               4 |
|           5 | 2012-05-01 | 13262.0074 |  3400 |               60 |                     59 |               5 |
|           6 | 2012-06-01 | 13158.0495 |  3817 |               61 |                     60 |               6 |
|           7 | 2012-07-01 | 13031.0190 |  4627 |               62 |                     61 |               7 |
|           8 | 2012-08-01 | 12932.0262 |  5419 |               63 |                     62 |               8 |
|          12 | 2012-12-01 | 15511.1194 |  6066 |               64 |                     63 |               9 |
|           9 | 2012-09-01 | 12654.4685 |  6087 |               65 |                     64 |              10 |
|          10 | 2012-10-01 | 13099.4931 |  6263 |               66 |                     65 |              11 |
|          11 | 2012-11-01 | 13741.2018 |  6382 |               67 |                     66 |              12 |
|           1 | 2013-01-01 | 15290.2175 |  6872 |               68 |                     67 |               1 |
|           2 | 2013-02-01 | 15893.5822 |  7561 |               69 |                     68 |               2 |
|           3 | 2013-03-01 | 15428.9254 |  8273 |               70 |                     69 |               3 |
|           4 | 2013-04-01 | 14876.9270 |  9419 |               71 |                     70 |               4 |
|           5 | 2013-05-01 | 14303.0411 | 10350 |               72 |                     71 |               5 |
|           6 | 2013-06-01 | 14502.5576 | 10899 |               73 |                     72 |               6 |
|           7 | 2013-07-01 | 14338.9442 | 11910 |               74 |                     73 |               7 |
|           8 | 2013-08-01 | 14204.8820 | 12674 |               75 |                     74 |               8 |
|           9 | 2013-09-01 | 14469.1711 | 12987 |               76 |                     75 |               9 |
|          10 | 2013-10-01 | 14493.0232 | 14129 |               77 |                     76 |              10 |
|          11 | 2013-11-01 | 14673.4188 | 14720 |               78 |                     77 |              11 |
|          12 | 2013-12-01 | 14924.4424 | 15020 |               79 |                     78 |              12 |
+-------------+------------+------------+-------+------------------+------------------------+-----------------+
79 rows in set (1.330 sec)




 
============================================================================================ 
FIRST_VALUE

select issue_d, 
       avg,
       first_value(avg) over (partition by year(issue_d) order by issue_d) first_value_avg, 
       last_value(avg) over (partition by year(issue_d) order by issue_d rows between unbounded preceding and unbounded following) last_value_avg, 
       count,
       first_value(count) over (partition by year(issue_d) order by issue_d desc) first_value_count, 
       last_value(count) over (partition by year(issue_d) order by issue_d desc rows between unbounded preceding and unbounded following) last_value_count
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
| issue_d    | avg        | first_value_avg | last_value_avg | count | first_value_count | last_value_count |
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
| 2007-06-01 |  3827.0833 |       3827.0833 |     10971.9477 |    24 |               172 |               24 |
| 2007-07-01 |  5528.9683 |       3827.0833 |     10971.9477 |    63 |               172 |               24 |
| 2007-08-01 |  6963.5135 |       3827.0833 |     10971.9477 |    74 |               172 |               24 |
| 2007-09-01 |  7036.7925 |       3827.0833 |     10971.9477 |    53 |               172 |               24 |
| 2007-10-01 |  7173.5714 |       3827.0833 |     10971.9477 |   105 |               172 |               24 |
| 2007-11-01 |  9005.8036 |       3827.0833 |     10971.9477 |   112 |               172 |               24 |
| 2007-12-01 | 10971.9477 |       3827.0833 |     10971.9477 |   172 |               172 |               24 |
| 2008-01-01 |  9593.4426 |       9593.4426 |     10146.1462 |   305 |               253 |              305 |
| 2008-02-01 |  9670.6699 |       9593.4426 |     10146.1462 |   306 |               253 |              305 |
| 2008-03-01 | 10323.5075 |       9593.4426 |     10146.1462 |   402 |               253 |              305 |
| 2008-04-01 |  9397.2008 |       9593.4426 |     10146.1462 |   259 |               253 |              305 |
| 2008-05-01 |  5468.6957 |       9593.4426 |     10146.1462 |   115 |               253 |              305 |
| 2008-06-01 |  5323.9919 |       9593.4426 |     10146.1462 |   124 |               253 |              305 |
| 2008-07-01 |  6074.2908 |       9593.4426 |     10146.1462 |   141 |               253 |              305 |
| 2008-08-01 |  5924.5000 |       9593.4426 |     10146.1462 |   100 |               253 |              305 |
| 2008-09-01 |  5573.2456 |       9593.4426 |     10146.1462 |    57 |               253 |              305 |
| 2008-10-01 |  7889.7541 |       9593.4426 |     10146.1462 |   122 |               253 |              305 |
| 2008-11-01 |  9879.9043 |       9593.4426 |     10146.1462 |   209 |               253 |              305 |
| 2008-12-01 | 10146.1462 |       9593.4426 |     10146.1462 |   253 |               253 |              305 |
| 2009-01-01 |  9182.6208 |       9182.6208 |     10830.5091 |   269 |               658 |              269 |
| 2009-02-01 |  8989.8179 |       9182.6208 |     10830.5091 |   302 |               658 |              269 |
| 2009-03-01 |  9448.4568 |       9182.6208 |     10830.5091 |   324 |               658 |              269 |
| 2009-04-01 |  9247.6727 |       9182.6208 |     10830.5091 |   333 |               658 |              269 |
| 2009-05-01 |  9591.3649 |       9182.6208 |     10830.5091 |   359 |               658 |              269 |
| 2009-06-01 |  8848.0296 |       9182.6208 |     10830.5091 |   406 |               658 |              269 |
| 2009-07-01 |  9431.0219 |       9182.6208 |     10830.5091 |   411 |               658 |              269 |
| 2009-08-01 |  9683.0717 |       9182.6208 |     10830.5091 |   446 |               658 |              269 |
| 2009-09-01 | 10073.4221 |       9182.6208 |     10830.5091 |   507 |               658 |              269 |
| 2009-10-01 | 10412.9967 |       9182.6208 |     10830.5091 |   604 |               658 |              269 |
| 2009-11-01 | 10345.7326 |       9182.6208 |     10830.5091 |   662 |               658 |              269 |
| 2009-12-01 | 10830.5091 |       9182.6208 |     10830.5091 |   658 |               658 |              269 |
| 2010-01-01 | 11157.0242 |      11157.0242 |     10703.3708 |   662 |              1335 |              662 |
| 2010-02-01 | 10938.4164 |      11157.0242 |     10703.3708 |   682 |              1335 |              662 |
| 2010-03-01 | 10464.6739 |      11157.0242 |     10703.3708 |   828 |              1335 |              662 |
| 2010-04-01 | 10428.2621 |      11157.0242 |     10703.3708 |   912 |              1335 |              662 |
| 2010-05-01 | 10726.1375 |      11157.0242 |     10703.3708 |   989 |              1335 |              662 |
| 2010-06-01 | 10108.1900 |      11157.0242 |     10703.3708 |  1105 |              1335 |              662 |
| 2010-07-01 |  9914.0365 |      11157.0242 |     10703.3708 |  1204 |              1335 |              662 |
| 2010-08-01 | 10299.4681 |      11157.0242 |     10703.3708 |  1175 |              1335 |              662 |
| 2010-09-01 | 10304.9622 |      11157.0242 |     10703.3708 |  1189 |              1335 |              662 |
| 2010-10-01 | 10659.1924 |      11157.0242 |     10703.3708 |  1232 |              1335 |              662 |
| 2010-11-01 | 11014.2770 |      11157.0242 |     10703.3708 |  1224 |              1335 |              662 |
| 2010-12-01 | 10703.3708 |      11157.0242 |     10703.3708 |  1335 |              1335 |              662 |
| 2011-01-01 | 10742.4457 |      10742.4457 |     13957.8738 |  1380 |              2267 |             1380 |
| 2011-02-01 | 11249.0562 |      10742.4457 |     13957.8738 |  1298 |              2267 |             1380 |
| 2011-03-01 | 11441.5228 |      10742.4457 |     13957.8738 |  1448 |              2267 |             1380 |
| 2011-04-01 | 11223.3365 |      10742.4457 |     13957.8738 |  1563 |              2267 |             1380 |
| 2011-05-01 | 11342.6937 |      10742.4457 |     13957.8738 |  1704 |              2267 |             1380 |
| 2011-06-01 | 11411.5531 |      10742.4457 |     13957.8738 |  1835 |              2267 |             1380 |
| 2011-07-01 | 11380.0533 |      10742.4457 |     13957.8738 |  1875 |              2267 |             1380 |
| 2011-08-01 | 12020.4369 |      10742.4457 |     13957.8738 |  1934 |              2267 |             1380 |
| 2011-09-01 | 12500.0726 |      10742.4457 |     13957.8738 |  2067 |              2267 |             1380 |
| 2011-10-01 | 12975.7082 |      10742.4457 |     13957.8738 |  2118 |              2267 |             1380 |
| 2011-11-01 | 12693.8172 |      10742.4457 |     13957.8738 |  2232 |              2267 |             1380 |
| 2011-12-01 | 13957.8738 |      10742.4457 |     13957.8738 |  2267 |              2267 |             1380 |
| 2012-01-01 | 13151.6045 |      13151.6045 |     15511.1194 |  2602 |              6066 |             2602 |
| 2012-02-01 | 14085.2246 |      13151.6045 |     15511.1194 |  2560 |              6066 |             2602 |
| 2012-03-01 | 13567.7076 |      13151.6045 |     15511.1194 |  2914 |              6066 |             2602 |
| 2012-04-01 | 13018.9241 |      13151.6045 |     15511.1194 |  3230 |              6066 |             2602 |
| 2012-05-01 | 13262.0074 |      13151.6045 |     15511.1194 |  3400 |              6066 |             2602 |
| 2012-06-01 | 13158.0495 |      13151.6045 |     15511.1194 |  3817 |              6066 |             2602 |
| 2012-07-01 | 13031.0190 |      13151.6045 |     15511.1194 |  4627 |              6066 |             2602 |
| 2012-08-01 | 12932.0262 |      13151.6045 |     15511.1194 |  5419 |              6066 |             2602 |
| 2012-09-01 | 12654.4685 |      13151.6045 |     15511.1194 |  6087 |              6066 |             2602 |
| 2012-10-01 | 13099.4931 |      13151.6045 |     15511.1194 |  6263 |              6066 |             2602 |
| 2012-11-01 | 13741.2018 |      13151.6045 |     15511.1194 |  6382 |              6066 |             2602 |
| 2012-12-01 | 15511.1194 |      13151.6045 |     15511.1194 |  6066 |              6066 |             2602 |
| 2013-01-01 | 15290.2175 |      15290.2175 |     14924.4424 |  6872 |             15020 |             6872 |
| 2013-02-01 | 15893.5822 |      15290.2175 |     14924.4424 |  7561 |             15020 |             6872 |
| 2013-03-01 | 15428.9254 |      15290.2175 |     14924.4424 |  8273 |             15020 |             6872 |
| 2013-04-01 | 14876.9270 |      15290.2175 |     14924.4424 |  9419 |             15020 |             6872 |
| 2013-05-01 | 14303.0411 |      15290.2175 |     14924.4424 | 10350 |             15020 |             6872 |
| 2013-06-01 | 14502.5576 |      15290.2175 |     14924.4424 | 10899 |             15020 |             6872 |
| 2013-07-01 | 14338.9442 |      15290.2175 |     14924.4424 | 11910 |             15020 |             6872 |
| 2013-08-01 | 14204.8820 |      15290.2175 |     14924.4424 | 12674 |             15020 |             6872 |
| 2013-09-01 | 14469.1711 |      15290.2175 |     14924.4424 | 12987 |             15020 |             6872 |
| 2013-10-01 | 14493.0232 |      15290.2175 |     14924.4424 | 14129 |             15020 |             6872 |
| 2013-11-01 | 14673.4188 |      15290.2175 |     14924.4424 | 14720 |             15020 |             6872 |
| 2013-12-01 | 14924.4424 |      15290.2175 |     14924.4424 | 15020 |             15020 |             6872 |
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
79 rows in set (54.36 sec)


 
============================================================================================ 
LAG

select issue_d, 
       avg,
       lag(avg, 1) over (partition by year(issue_d) order by issue_d) previous_avg, 
       avg - lag(avg, 1) over (partition by year(issue_d) order by issue_d) prev_change_avg, 
       lag(avg, -1) over (partition by year(issue_d) order by issue_d) next_avg, 
       avg - lag(avg, -1) over (partition by year(issue_d) order by issue_d) next_change_avg
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+------------+------------+--------------+-----------------+------------+-----------------+
| issue_d    | avg        | previous_avg | prev_change_avg | next_avg   | next_change_avg |
+------------+------------+--------------+-----------------+------------+-----------------+
| 2007-06-01 |  3827.0833 |         NULL |            NULL |  5528.9683 |      -1701.8850 |
| 2007-07-01 |  5528.9683 |    3827.0833 |       1701.8850 |  6963.5135 |      -1434.5452 |
| 2007-08-01 |  6963.5135 |    5528.9683 |       1434.5452 |  7036.7925 |        -73.2790 |
| 2007-09-01 |  7036.7925 |    6963.5135 |         73.2790 |  7173.5714 |       -136.7789 |
| 2007-10-01 |  7173.5714 |    7036.7925 |        136.7789 |  9005.8036 |      -1832.2322 |
| 2007-11-01 |  9005.8036 |    7173.5714 |       1832.2322 | 10971.9477 |      -1966.1441 |
| 2007-12-01 | 10971.9477 |    9005.8036 |       1966.1441 |       NULL |            NULL |
| 2008-01-01 |  9593.4426 |         NULL |            NULL |  9670.6699 |        -77.2273 |
| 2008-02-01 |  9670.6699 |    9593.4426 |         77.2273 | 10323.5075 |       -652.8376 |
| 2008-03-01 | 10323.5075 |    9670.6699 |        652.8376 |  9397.2008 |        926.3067 |
| 2008-04-01 |  9397.2008 |   10323.5075 |       -926.3067 |  5468.6957 |       3928.5051 |
| 2008-05-01 |  5468.6957 |    9397.2008 |      -3928.5051 |  5323.9919 |        144.7038 |
| 2008-06-01 |  5323.9919 |    5468.6957 |       -144.7038 |  6074.2908 |       -750.2989 |
| 2008-07-01 |  6074.2908 |    5323.9919 |        750.2989 |  5924.5000 |        149.7908 |
| 2008-08-01 |  5924.5000 |    6074.2908 |       -149.7908 |  5573.2456 |        351.2544 |
| 2008-09-01 |  5573.2456 |    5924.5000 |       -351.2544 |  7889.7541 |      -2316.5085 |
| 2008-10-01 |  7889.7541 |    5573.2456 |       2316.5085 |  9879.9043 |      -1990.1502 |
| 2008-11-01 |  9879.9043 |    7889.7541 |       1990.1502 | 10146.1462 |       -266.2419 |
| 2008-12-01 | 10146.1462 |    9879.9043 |        266.2419 |       NULL |            NULL |
| 2009-01-01 |  9182.6208 |         NULL |            NULL |  8989.8179 |        192.8029 |
| 2009-02-01 |  8989.8179 |    9182.6208 |       -192.8029 |  9448.4568 |       -458.6389 |
| 2009-03-01 |  9448.4568 |    8989.8179 |        458.6389 |  9247.6727 |        200.7841 |
| 2009-04-01 |  9247.6727 |    9448.4568 |       -200.7841 |  9591.3649 |       -343.6922 |
| 2009-05-01 |  9591.3649 |    9247.6727 |        343.6922 |  8848.0296 |        743.3353 |
| 2009-06-01 |  8848.0296 |    9591.3649 |       -743.3353 |  9431.0219 |       -582.9923 |
| 2009-07-01 |  9431.0219 |    8848.0296 |        582.9923 |  9683.0717 |       -252.0498 |
| 2009-08-01 |  9683.0717 |    9431.0219 |        252.0498 | 10073.4221 |       -390.3504 |
| 2009-09-01 | 10073.4221 |    9683.0717 |        390.3504 | 10412.9967 |       -339.5746 |
| 2009-10-01 | 10412.9967 |   10073.4221 |        339.5746 | 10345.7326 |         67.2641 |
| 2009-11-01 | 10345.7326 |   10412.9967 |        -67.2641 | 10830.5091 |       -484.7765 |
| 2009-12-01 | 10830.5091 |   10345.7326 |        484.7765 |       NULL |            NULL |
| 2010-01-01 | 11157.0242 |         NULL |            NULL | 10938.4164 |        218.6078 |
| 2010-02-01 | 10938.4164 |   11157.0242 |       -218.6078 | 10464.6739 |        473.7425 |
| 2010-03-01 | 10464.6739 |   10938.4164 |       -473.7425 | 10428.2621 |         36.4118 |
| 2010-04-01 | 10428.2621 |   10464.6739 |        -36.4118 | 10726.1375 |       -297.8754 |
| 2010-05-01 | 10726.1375 |   10428.2621 |        297.8754 | 10108.1900 |        617.9475 |
| 2010-06-01 | 10108.1900 |   10726.1375 |       -617.9475 |  9914.0365 |        194.1535 |
| 2010-07-01 |  9914.0365 |   10108.1900 |       -194.1535 | 10299.4681 |       -385.4316 |
| 2010-08-01 | 10299.4681 |    9914.0365 |        385.4316 | 10304.9622 |         -5.4941 |
| 2010-09-01 | 10304.9622 |   10299.4681 |          5.4941 | 10659.1924 |       -354.2302 |
| 2010-10-01 | 10659.1924 |   10304.9622 |        354.2302 | 11014.2770 |       -355.0846 |
| 2010-11-01 | 11014.2770 |   10659.1924 |        355.0846 | 10703.3708 |        310.9062 |
| 2010-12-01 | 10703.3708 |   11014.2770 |       -310.9062 |       NULL |            NULL |
| 2011-01-01 | 10742.4457 |         NULL |            NULL | 11249.0562 |       -506.6105 |
| 2011-02-01 | 11249.0562 |   10742.4457 |        506.6105 | 11441.5228 |       -192.4666 |
| 2011-03-01 | 11441.5228 |   11249.0562 |        192.4666 | 11223.3365 |        218.1863 |
| 2011-04-01 | 11223.3365 |   11441.5228 |       -218.1863 | 11342.6937 |       -119.3572 |
| 2011-05-01 | 11342.6937 |   11223.3365 |        119.3572 | 11411.5531 |        -68.8594 |
| 2011-06-01 | 11411.5531 |   11342.6937 |         68.8594 | 11380.0533 |         31.4998 |
| 2011-07-01 | 11380.0533 |   11411.5531 |        -31.4998 | 12020.4369 |       -640.3836 |
| 2011-08-01 | 12020.4369 |   11380.0533 |        640.3836 | 12500.0726 |       -479.6357 |
| 2011-09-01 | 12500.0726 |   12020.4369 |        479.6357 | 12975.7082 |       -475.6356 |
| 2011-10-01 | 12975.7082 |   12500.0726 |        475.6356 | 12693.8172 |        281.8910 |
| 2011-11-01 | 12693.8172 |   12975.7082 |       -281.8910 | 13957.8738 |      -1264.0566 |
| 2011-12-01 | 13957.8738 |   12693.8172 |       1264.0566 |       NULL |            NULL |
| 2012-01-01 | 13151.6045 |         NULL |            NULL | 14085.2246 |       -933.6201 |
| 2012-02-01 | 14085.2246 |   13151.6045 |        933.6201 | 13567.7076 |        517.5170 |
| 2012-03-01 | 13567.7076 |   14085.2246 |       -517.5170 | 13018.9241 |        548.7835 |
| 2012-04-01 | 13018.9241 |   13567.7076 |       -548.7835 | 13262.0074 |       -243.0833 |
| 2012-05-01 | 13262.0074 |   13018.9241 |        243.0833 | 13158.0495 |        103.9579 |
| 2012-06-01 | 13158.0495 |   13262.0074 |       -103.9579 | 13031.0190 |        127.0305 |
| 2012-07-01 | 13031.0190 |   13158.0495 |       -127.0305 | 12932.0262 |         98.9928 |
| 2012-08-01 | 12932.0262 |   13031.0190 |        -98.9928 | 12654.4685 |        277.5577 |
| 2012-09-01 | 12654.4685 |   12932.0262 |       -277.5577 | 13099.4931 |       -445.0246 |
| 2012-10-01 | 13099.4931 |   12654.4685 |        445.0246 | 13741.2018 |       -641.7087 |
| 2012-11-01 | 13741.2018 |   13099.4931 |        641.7087 | 15511.1194 |      -1769.9176 |
| 2012-12-01 | 15511.1194 |   13741.2018 |       1769.9176 |       NULL |            NULL |
| 2013-01-01 | 15290.2175 |         NULL |            NULL | 15893.5822 |       -603.3647 |
| 2013-02-01 | 15893.5822 |   15290.2175 |        603.3647 | 15428.9254 |        464.6568 |
| 2013-03-01 | 15428.9254 |   15893.5822 |       -464.6568 | 14876.9270 |        551.9984 |
| 2013-04-01 | 14876.9270 |   15428.9254 |       -551.9984 | 14303.0411 |        573.8859 |
| 2013-05-01 | 14303.0411 |   14876.9270 |       -573.8859 | 14502.5576 |       -199.5165 |
| 2013-06-01 | 14502.5576 |   14303.0411 |        199.5165 | 14338.9442 |        163.6134 |
| 2013-07-01 | 14338.9442 |   14502.5576 |       -163.6134 | 14204.8820 |        134.0622 |
| 2013-08-01 | 14204.8820 |   14338.9442 |       -134.0622 | 14469.1711 |       -264.2891 |
| 2013-09-01 | 14469.1711 |   14204.8820 |        264.2891 | 14493.0232 |        -23.8521 |
| 2013-10-01 | 14493.0232 |   14469.1711 |         23.8521 | 14673.4188 |       -180.3956 |
| 2013-11-01 | 14673.4188 |   14493.0232 |        180.3956 | 14924.4424 |       -251.0236 |
| 2013-12-01 | 14924.4424 |   14673.4188 |        251.0236 |       NULL |            NULL |
+------------+------------+--------------+-----------------+------------+-----------------+
79 rows in set (58.41 sec)

 
============================================================================================ 
LAST_VALUE

select issue_d, 
       avg,
       first_value(avg) over (partition by year(issue_d) order by issue_d) first_value_avg, 
       last_value(avg) over (partition by year(issue_d) order by issue_d rows between unbounded preceding and unbounded following) last_value_avg, 
       count,
       first_value(count) over (partition by year(issue_d) order by issue_d desc) first_value_count, 
       last_value(count) over (partition by year(issue_d) order by issue_d desc rows between unbounded preceding and unbounded following) last_value_count
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
| issue_d    | avg        | first_value_avg | last_value_avg | count | first_value_count | last_value_count |
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
| 2007-06-01 |  3827.0833 |       3827.0833 |     10971.9477 |    24 |               172 |               24 |
| 2007-07-01 |  5528.9683 |       3827.0833 |     10971.9477 |    63 |               172 |               24 |
| 2007-08-01 |  6963.5135 |       3827.0833 |     10971.9477 |    74 |               172 |               24 |
| 2007-09-01 |  7036.7925 |       3827.0833 |     10971.9477 |    53 |               172 |               24 |
| 2007-10-01 |  7173.5714 |       3827.0833 |     10971.9477 |   105 |               172 |               24 |
| 2007-11-01 |  9005.8036 |       3827.0833 |     10971.9477 |   112 |               172 |               24 |
| 2007-12-01 | 10971.9477 |       3827.0833 |     10971.9477 |   172 |               172 |               24 |
| 2008-01-01 |  9593.4426 |       9593.4426 |     10146.1462 |   305 |               253 |              305 |
| 2008-02-01 |  9670.6699 |       9593.4426 |     10146.1462 |   306 |               253 |              305 |
| 2008-03-01 | 10323.5075 |       9593.4426 |     10146.1462 |   402 |               253 |              305 |
| 2008-04-01 |  9397.2008 |       9593.4426 |     10146.1462 |   259 |               253 |              305 |
| 2008-05-01 |  5468.6957 |       9593.4426 |     10146.1462 |   115 |               253 |              305 |
| 2008-06-01 |  5323.9919 |       9593.4426 |     10146.1462 |   124 |               253 |              305 |
| 2008-07-01 |  6074.2908 |       9593.4426 |     10146.1462 |   141 |               253 |              305 |
| 2008-08-01 |  5924.5000 |       9593.4426 |     10146.1462 |   100 |               253 |              305 |
| 2008-09-01 |  5573.2456 |       9593.4426 |     10146.1462 |    57 |               253 |              305 |
| 2008-10-01 |  7889.7541 |       9593.4426 |     10146.1462 |   122 |               253 |              305 |
| 2008-11-01 |  9879.9043 |       9593.4426 |     10146.1462 |   209 |               253 |              305 |
| 2008-12-01 | 10146.1462 |       9593.4426 |     10146.1462 |   253 |               253 |              305 |
| 2009-01-01 |  9182.6208 |       9182.6208 |     10830.5091 |   269 |               658 |              269 |
| 2009-02-01 |  8989.8179 |       9182.6208 |     10830.5091 |   302 |               658 |              269 |
| 2009-03-01 |  9448.4568 |       9182.6208 |     10830.5091 |   324 |               658 |              269 |
| 2009-04-01 |  9247.6727 |       9182.6208 |     10830.5091 |   333 |               658 |              269 |
| 2009-05-01 |  9591.3649 |       9182.6208 |     10830.5091 |   359 |               658 |              269 |
| 2009-06-01 |  8848.0296 |       9182.6208 |     10830.5091 |   406 |               658 |              269 |
| 2009-07-01 |  9431.0219 |       9182.6208 |     10830.5091 |   411 |               658 |              269 |
| 2009-08-01 |  9683.0717 |       9182.6208 |     10830.5091 |   446 |               658 |              269 |
| 2009-09-01 | 10073.4221 |       9182.6208 |     10830.5091 |   507 |               658 |              269 |
| 2009-10-01 | 10412.9967 |       9182.6208 |     10830.5091 |   604 |               658 |              269 |
| 2009-11-01 | 10345.7326 |       9182.6208 |     10830.5091 |   662 |               658 |              269 |
| 2009-12-01 | 10830.5091 |       9182.6208 |     10830.5091 |   658 |               658 |              269 |
| 2010-01-01 | 11157.0242 |      11157.0242 |     10703.3708 |   662 |              1335 |              662 |
| 2010-02-01 | 10938.4164 |      11157.0242 |     10703.3708 |   682 |              1335 |              662 |
| 2010-03-01 | 10464.6739 |      11157.0242 |     10703.3708 |   828 |              1335 |              662 |
| 2010-04-01 | 10428.2621 |      11157.0242 |     10703.3708 |   912 |              1335 |              662 |
| 2010-05-01 | 10726.1375 |      11157.0242 |     10703.3708 |   989 |              1335 |              662 |
| 2010-06-01 | 10108.1900 |      11157.0242 |     10703.3708 |  1105 |              1335 |              662 |
| 2010-07-01 |  9914.0365 |      11157.0242 |     10703.3708 |  1204 |              1335 |              662 |
| 2010-08-01 | 10299.4681 |      11157.0242 |     10703.3708 |  1175 |              1335 |              662 |
| 2010-09-01 | 10304.9622 |      11157.0242 |     10703.3708 |  1189 |              1335 |              662 |
| 2010-10-01 | 10659.1924 |      11157.0242 |     10703.3708 |  1232 |              1335 |              662 |
| 2010-11-01 | 11014.2770 |      11157.0242 |     10703.3708 |  1224 |              1335 |              662 |
| 2010-12-01 | 10703.3708 |      11157.0242 |     10703.3708 |  1335 |              1335 |              662 |
| 2011-01-01 | 10742.4457 |      10742.4457 |     13957.8738 |  1380 |              2267 |             1380 |
| 2011-02-01 | 11249.0562 |      10742.4457 |     13957.8738 |  1298 |              2267 |             1380 |
| 2011-03-01 | 11441.5228 |      10742.4457 |     13957.8738 |  1448 |              2267 |             1380 |
| 2011-04-01 | 11223.3365 |      10742.4457 |     13957.8738 |  1563 |              2267 |             1380 |
| 2011-05-01 | 11342.6937 |      10742.4457 |     13957.8738 |  1704 |              2267 |             1380 |
| 2011-06-01 | 11411.5531 |      10742.4457 |     13957.8738 |  1835 |              2267 |             1380 |
| 2011-07-01 | 11380.0533 |      10742.4457 |     13957.8738 |  1875 |              2267 |             1380 |
| 2011-08-01 | 12020.4369 |      10742.4457 |     13957.8738 |  1934 |              2267 |             1380 |
| 2011-09-01 | 12500.0726 |      10742.4457 |     13957.8738 |  2067 |              2267 |             1380 |
| 2011-10-01 | 12975.7082 |      10742.4457 |     13957.8738 |  2118 |              2267 |             1380 |
| 2011-11-01 | 12693.8172 |      10742.4457 |     13957.8738 |  2232 |              2267 |             1380 |
| 2011-12-01 | 13957.8738 |      10742.4457 |     13957.8738 |  2267 |              2267 |             1380 |
| 2012-01-01 | 13151.6045 |      13151.6045 |     15511.1194 |  2602 |              6066 |             2602 |
| 2012-02-01 | 14085.2246 |      13151.6045 |     15511.1194 |  2560 |              6066 |             2602 |
| 2012-03-01 | 13567.7076 |      13151.6045 |     15511.1194 |  2914 |              6066 |             2602 |
| 2012-04-01 | 13018.9241 |      13151.6045 |     15511.1194 |  3230 |              6066 |             2602 |
| 2012-05-01 | 13262.0074 |      13151.6045 |     15511.1194 |  3400 |              6066 |             2602 |
| 2012-06-01 | 13158.0495 |      13151.6045 |     15511.1194 |  3817 |              6066 |             2602 |
| 2012-07-01 | 13031.0190 |      13151.6045 |     15511.1194 |  4627 |              6066 |             2602 |
| 2012-08-01 | 12932.0262 |      13151.6045 |     15511.1194 |  5419 |              6066 |             2602 |
| 2012-09-01 | 12654.4685 |      13151.6045 |     15511.1194 |  6087 |              6066 |             2602 |
| 2012-10-01 | 13099.4931 |      13151.6045 |     15511.1194 |  6263 |              6066 |             2602 |
| 2012-11-01 | 13741.2018 |      13151.6045 |     15511.1194 |  6382 |              6066 |             2602 |
| 2012-12-01 | 15511.1194 |      13151.6045 |     15511.1194 |  6066 |              6066 |             2602 |
| 2013-01-01 | 15290.2175 |      15290.2175 |     14924.4424 |  6872 |             15020 |             6872 |
| 2013-02-01 | 15893.5822 |      15290.2175 |     14924.4424 |  7561 |             15020 |             6872 |
| 2013-03-01 | 15428.9254 |      15290.2175 |     14924.4424 |  8273 |             15020 |             6872 |
| 2013-04-01 | 14876.9270 |      15290.2175 |     14924.4424 |  9419 |             15020 |             6872 |
| 2013-05-01 | 14303.0411 |      15290.2175 |     14924.4424 | 10350 |             15020 |             6872 |
| 2013-06-01 | 14502.5576 |      15290.2175 |     14924.4424 | 10899 |             15020 |             6872 |
| 2013-07-01 | 14338.9442 |      15290.2175 |     14924.4424 | 11910 |             15020 |             6872 |
| 2013-08-01 | 14204.8820 |      15290.2175 |     14924.4424 | 12674 |             15020 |             6872 |
| 2013-09-01 | 14469.1711 |      15290.2175 |     14924.4424 | 12987 |             15020 |             6872 |
| 2013-10-01 | 14493.0232 |      15290.2175 |     14924.4424 | 14129 |             15020 |             6872 |
| 2013-11-01 | 14673.4188 |      15290.2175 |     14924.4424 | 14720 |             15020 |             6872 |
| 2013-12-01 | 14924.4424 |      15290.2175 |     14924.4424 | 15020 |             15020 |             6872 |
+------------+------------+-----------------+----------------+-------+-------------------+------------------+
79 rows in set (54.36 sec)


 
============================================================================================ 
LEAD

select issue_d, 
       count,
       lead(count, 1) over (partition by year(issue_d) order by issue_d) next_count, 
       count - lead(count, 1) over (partition by year(issue_d) order by issue_d) next_change_count, 
       lead(count, -1) over (partition by year(issue_d) order by issue_d) prev_count, 
       count - lead(count, -1) over (partition by year(issue_d) order by issue_d) prev_change_count
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+------------+-------+------------+-------------------+------------+-------------------+
| issue_d    | count | next_count | next_change_count | prev_count | prev_change_count |
+------------+-------+------------+-------------------+------------+-------------------+
| 2007-06-01 |    24 |         63 |               -39 |       NULL |              NULL |
| 2007-07-01 |    63 |         74 |               -11 |         24 |                39 |
| 2007-08-01 |    74 |         53 |                21 |         63 |                11 |
| 2007-09-01 |    53 |        105 |               -52 |         74 |               -21 |
| 2007-10-01 |   105 |        112 |                -7 |         53 |                52 |
| 2007-11-01 |   112 |        172 |               -60 |        105 |                 7 |
| 2007-12-01 |   172 |       NULL |              NULL |        112 |                60 |
| 2008-01-01 |   305 |        306 |                -1 |       NULL |              NULL |
| 2008-02-01 |   306 |        402 |               -96 |        305 |                 1 |
| 2008-03-01 |   402 |        259 |               143 |        306 |                96 |
| 2008-04-01 |   259 |        115 |               144 |        402 |              -143 |
| 2008-05-01 |   115 |        124 |                -9 |        259 |              -144 |
| 2008-06-01 |   124 |        141 |               -17 |        115 |                 9 |
| 2008-07-01 |   141 |        100 |                41 |        124 |                17 |
| 2008-08-01 |   100 |         57 |                43 |        141 |               -41 |
| 2008-09-01 |    57 |        122 |               -65 |        100 |               -43 |
| 2008-10-01 |   122 |        209 |               -87 |         57 |                65 |
| 2008-11-01 |   209 |        253 |               -44 |        122 |                87 |
| 2008-12-01 |   253 |       NULL |              NULL |        209 |                44 |
| 2009-01-01 |   269 |        302 |               -33 |       NULL |              NULL |
| 2009-02-01 |   302 |        324 |               -22 |        269 |                33 |
| 2009-03-01 |   324 |        333 |                -9 |        302 |                22 |
| 2009-04-01 |   333 |        359 |               -26 |        324 |                 9 |
| 2009-05-01 |   359 |        406 |               -47 |        333 |                26 |
| 2009-06-01 |   406 |        411 |                -5 |        359 |                47 |
| 2009-07-01 |   411 |        446 |               -35 |        406 |                 5 |
| 2009-08-01 |   446 |        507 |               -61 |        411 |                35 |
| 2009-09-01 |   507 |        604 |               -97 |        446 |                61 |
| 2009-10-01 |   604 |        662 |               -58 |        507 |                97 |
| 2009-11-01 |   662 |        658 |                 4 |        604 |                58 |
| 2009-12-01 |   658 |       NULL |              NULL |        662 |                -4 |
| 2010-01-01 |   662 |        682 |               -20 |       NULL |              NULL |
| 2010-02-01 |   682 |        828 |              -146 |        662 |                20 |
| 2010-03-01 |   828 |        912 |               -84 |        682 |               146 |
| 2010-04-01 |   912 |        989 |               -77 |        828 |                84 |
| 2010-05-01 |   989 |       1105 |              -116 |        912 |                77 |
| 2010-06-01 |  1105 |       1204 |               -99 |        989 |               116 |
| 2010-07-01 |  1204 |       1175 |                29 |       1105 |                99 |
| 2010-08-01 |  1175 |       1189 |               -14 |       1204 |               -29 |
| 2010-09-01 |  1189 |       1232 |               -43 |       1175 |                14 |
| 2010-10-01 |  1232 |       1224 |                 8 |       1189 |                43 |
| 2010-11-01 |  1224 |       1335 |              -111 |       1232 |                -8 |
| 2010-12-01 |  1335 |       NULL |              NULL |       1224 |               111 |
| 2011-01-01 |  1380 |       1298 |                82 |       NULL |              NULL |
| 2011-02-01 |  1298 |       1448 |              -150 |       1380 |               -82 |
| 2011-03-01 |  1448 |       1563 |              -115 |       1298 |               150 |
| 2011-04-01 |  1563 |       1704 |              -141 |       1448 |               115 |
| 2011-05-01 |  1704 |       1835 |              -131 |       1563 |               141 |
| 2011-06-01 |  1835 |       1875 |               -40 |       1704 |               131 |
| 2011-07-01 |  1875 |       1934 |               -59 |       1835 |                40 |
| 2011-08-01 |  1934 |       2067 |              -133 |       1875 |                59 |
| 2011-09-01 |  2067 |       2118 |               -51 |       1934 |               133 |
| 2011-10-01 |  2118 |       2232 |              -114 |       2067 |                51 |
| 2011-11-01 |  2232 |       2267 |               -35 |       2118 |               114 |
| 2011-12-01 |  2267 |       NULL |              NULL |       2232 |                35 |
| 2012-01-01 |  2602 |       2560 |                42 |       NULL |              NULL |
| 2012-02-01 |  2560 |       2914 |              -354 |       2602 |               -42 |
| 2012-03-01 |  2914 |       3230 |              -316 |       2560 |               354 |
| 2012-04-01 |  3230 |       3400 |              -170 |       2914 |               316 |
| 2012-05-01 |  3400 |       3817 |              -417 |       3230 |               170 |
| 2012-06-01 |  3817 |       4627 |              -810 |       3400 |               417 |
| 2012-07-01 |  4627 |       5419 |              -792 |       3817 |               810 |
| 2012-08-01 |  5419 |       6087 |              -668 |       4627 |               792 |
| 2012-09-01 |  6087 |       6263 |              -176 |       5419 |               668 |
| 2012-10-01 |  6263 |       6382 |              -119 |       6087 |               176 |
| 2012-11-01 |  6382 |       6066 |               316 |       6263 |               119 |
| 2012-12-01 |  6066 |       NULL |              NULL |       6382 |              -316 |
| 2013-01-01 |  6872 |       7561 |              -689 |       NULL |              NULL |
| 2013-02-01 |  7561 |       8273 |              -712 |       6872 |               689 |
| 2013-03-01 |  8273 |       9419 |             -1146 |       7561 |               712 |
| 2013-04-01 |  9419 |      10350 |              -931 |       8273 |              1146 |
| 2013-05-01 | 10350 |      10899 |              -549 |       9419 |               931 |
| 2013-06-01 | 10899 |      11910 |             -1011 |      10350 |               549 |
| 2013-07-01 | 11910 |      12674 |              -764 |      10899 |              1011 |
| 2013-08-01 | 12674 |      12987 |              -313 |      11910 |               764 |
| 2013-09-01 | 12987 |      14129 |             -1142 |      12674 |               313 |
| 2013-10-01 | 14129 |      14720 |              -591 |      12987 |              1142 |
| 2013-11-01 | 14720 |      15020 |              -300 |      14129 |               591 |
| 2013-12-01 | 15020 |       NULL |              NULL |      14720 |               300 |
+------------+-------+------------+-------------------+------------+-------------------+
79 rows in set (54.12 sec)

 
============================================================================================ 
MEDIAN

select distinct *       
from (select year, 
             median(loan_amnt) over (partition by year) median 
      from loanstats) t 
group by t.year, 
         t.median 
order by t.year;
+------+------------------+
| year | median           |
+------+------------------+
| 2007 |  6000.0000000000 |
| 2008 |  7500.0000000000 |
| 2009 |  8800.0000000000 |
| 2010 |  9300.0000000000 |
| 2011 | 10000.0000000000 |
| 2012 | 12000.0000000000 |
| 2013 | 13000.0000000000 |
+------+------------------+
7 rows in set (0.419 sec)


 
============================================================================================ 
NTH_VALUE

select issue_d, 
       avg,
       nth_value(avg, 2) over (partition by year(issue_d) order by issue_d) 2nd_avg, 
       nth_value(avg, 5) over (partition by year(issue_d) order by issue_d) 5th_avg, 
       nth_value(avg, 8) over (partition by year(issue_d) order by issue_d) 8th_avg
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+------------+------------+------------+------------+------------+
| issue_d    | avg        | 2nd_avg    | 5th_avg    | 8th_avg    |
+------------+------------+------------+------------+------------+
| 2007-06-01 |  3827.0833 |       NULL |       NULL |       NULL |
| 2007-07-01 |  5528.9683 |  5528.9683 |       NULL |       NULL |
| 2007-08-01 |  6963.5135 |  5528.9683 |       NULL |       NULL |
| 2007-09-01 |  7036.7925 |  5528.9683 |       NULL |       NULL |
| 2007-10-01 |  7173.5714 |  5528.9683 |  7173.5714 |       NULL |
| 2007-11-01 |  9005.8036 |  5528.9683 |  7173.5714 |       NULL |
| 2007-12-01 | 10971.9477 |  5528.9683 |  7173.5714 |       NULL |
| 2008-01-01 |  9593.4426 |       NULL |       NULL |       NULL |
| 2008-02-01 |  9670.6699 |  9670.6699 |       NULL |       NULL |
| 2008-03-01 | 10323.5075 |  9670.6699 |       NULL |       NULL |
| 2008-04-01 |  9397.2008 |  9670.6699 |       NULL |       NULL |
| 2008-05-01 |  5468.6957 |  9670.6699 |  5468.6957 |       NULL |
| 2008-06-01 |  5323.9919 |  9670.6699 |  5468.6957 |       NULL |
| 2008-07-01 |  6074.2908 |  9670.6699 |  5468.6957 |       NULL |
| 2008-08-01 |  5924.5000 |  9670.6699 |  5468.6957 |  5924.5000 |
| 2008-09-01 |  5573.2456 |  9670.6699 |  5468.6957 |  5924.5000 |
| 2008-10-01 |  7889.7541 |  9670.6699 |  5468.6957 |  5924.5000 |
| 2008-11-01 |  9879.9043 |  9670.6699 |  5468.6957 |  5924.5000 |
| 2008-12-01 | 10146.1462 |  9670.6699 |  5468.6957 |  5924.5000 |
| 2009-01-01 |  9182.6208 |       NULL |       NULL |       NULL |
| 2009-02-01 |  8989.8179 |  8989.8179 |       NULL |       NULL |
| 2009-03-01 |  9448.4568 |  8989.8179 |       NULL |       NULL |
| 2009-04-01 |  9247.6727 |  8989.8179 |       NULL |       NULL |
| 2009-05-01 |  9591.3649 |  8989.8179 |  9591.3649 |       NULL |
| 2009-06-01 |  8848.0296 |  8989.8179 |  9591.3649 |       NULL |
| 2009-07-01 |  9431.0219 |  8989.8179 |  9591.3649 |       NULL |
| 2009-08-01 |  9683.0717 |  8989.8179 |  9591.3649 |  9683.0717 |
| 2009-09-01 | 10073.4221 |  8989.8179 |  9591.3649 |  9683.0717 |
| 2009-10-01 | 10412.9967 |  8989.8179 |  9591.3649 |  9683.0717 |
| 2009-11-01 | 10345.7326 |  8989.8179 |  9591.3649 |  9683.0717 |
| 2009-12-01 | 10830.5091 |  8989.8179 |  9591.3649 |  9683.0717 |
| 2010-01-01 | 11157.0242 |       NULL |       NULL |       NULL |
| 2010-02-01 | 10938.4164 | 10938.4164 |       NULL |       NULL |
| 2010-03-01 | 10464.6739 | 10938.4164 |       NULL |       NULL |
| 2010-04-01 | 10428.2621 | 10938.4164 |       NULL |       NULL |
| 2010-05-01 | 10726.1375 | 10938.4164 | 10726.1375 |       NULL |
| 2010-06-01 | 10108.1900 | 10938.4164 | 10726.1375 |       NULL |
| 2010-07-01 |  9914.0365 | 10938.4164 | 10726.1375 |       NULL |
| 2010-08-01 | 10299.4681 | 10938.4164 | 10726.1375 | 10299.4681 |
| 2010-09-01 | 10304.9622 | 10938.4164 | 10726.1375 | 10299.4681 |
| 2010-10-01 | 10659.1924 | 10938.4164 | 10726.1375 | 10299.4681 |
| 2010-11-01 | 11014.2770 | 10938.4164 | 10726.1375 | 10299.4681 |
| 2010-12-01 | 10703.3708 | 10938.4164 | 10726.1375 | 10299.4681 |
| 2011-01-01 | 10742.4457 |       NULL |       NULL |       NULL |
| 2011-02-01 | 11249.0562 | 11249.0562 |       NULL |       NULL |
| 2011-03-01 | 11441.5228 | 11249.0562 |       NULL |       NULL |
| 2011-04-01 | 11223.3365 | 11249.0562 |       NULL |       NULL |
| 2011-05-01 | 11342.6937 | 11249.0562 | 11342.6937 |       NULL |
| 2011-06-01 | 11411.5531 | 11249.0562 | 11342.6937 |       NULL |
| 2011-07-01 | 11380.0533 | 11249.0562 | 11342.6937 |       NULL |
| 2011-08-01 | 12020.4369 | 11249.0562 | 11342.6937 | 12020.4369 |
| 2011-09-01 | 12500.0726 | 11249.0562 | 11342.6937 | 12020.4369 |
| 2011-10-01 | 12975.7082 | 11249.0562 | 11342.6937 | 12020.4369 |
| 2011-11-01 | 12693.8172 | 11249.0562 | 11342.6937 | 12020.4369 |
| 2011-12-01 | 13957.8738 | 11249.0562 | 11342.6937 | 12020.4369 |
| 2012-01-01 | 13151.6045 |       NULL |       NULL |       NULL |
| 2012-02-01 | 14085.2246 | 14085.2246 |       NULL |       NULL |
| 2012-03-01 | 13567.7076 | 14085.2246 |       NULL |       NULL |
| 2012-04-01 | 13018.9241 | 14085.2246 |       NULL |       NULL |
| 2012-05-01 | 13262.0074 | 14085.2246 | 13262.0074 |       NULL |
| 2012-06-01 | 13158.0495 | 14085.2246 | 13262.0074 |       NULL |
| 2012-07-01 | 13031.0190 | 14085.2246 | 13262.0074 |       NULL |
| 2012-08-01 | 12932.0262 | 14085.2246 | 13262.0074 | 12932.0262 |
| 2012-09-01 | 12654.4685 | 14085.2246 | 13262.0074 | 12932.0262 |
| 2012-10-01 | 13099.4931 | 14085.2246 | 13262.0074 | 12932.0262 |
| 2012-11-01 | 13741.2018 | 14085.2246 | 13262.0074 | 12932.0262 |
| 2012-12-01 | 15511.1194 | 14085.2246 | 13262.0074 | 12932.0262 |
| 2013-01-01 | 15290.2175 |       NULL |       NULL |       NULL |
| 2013-02-01 | 15893.5822 | 15893.5822 |       NULL |       NULL |
| 2013-03-01 | 15428.9254 | 15893.5822 |       NULL |       NULL |
| 2013-04-01 | 14876.9270 | 15893.5822 |       NULL |       NULL |
| 2013-05-01 | 14303.0411 | 15893.5822 | 14303.0411 |       NULL |
| 2013-06-01 | 14502.5576 | 15893.5822 | 14303.0411 |       NULL |
| 2013-07-01 | 14338.9442 | 15893.5822 | 14303.0411 |       NULL |
| 2013-08-01 | 14204.8820 | 15893.5822 | 14303.0411 | 14204.8820 |
| 2013-09-01 | 14469.1711 | 15893.5822 | 14303.0411 | 14204.8820 |
| 2013-10-01 | 14493.0232 | 15893.5822 | 14303.0411 | 14204.8820 |
| 2013-11-01 | 14673.4188 | 15893.5822 | 14303.0411 | 14204.8820 |
| 2013-12-01 | 14924.4424 | 15893.5822 | 14303.0411 | 14204.8820 |
+------------+------------+------------+------------+------------+
79 rows in set (57.90 sec)


 
============================================================================================ 
NTILE
select year, 
       quartile, 
       min(loan_amnt), 
       max(loan_amnt),
       count(*)       
from (select year, 
             loan_amnt, 
             ntile(4) over (partition by year order by loan_amnt asc) quartile 
      from loanstats) t 
group by t.year, 
         t.quartile 
order by t.year, 
         t.quartile;
+------+----------+----------------+----------------+----------+
| year | quartile | min(loan_amnt) | max(loan_amnt) | count(*) |
+------+----------+----------------+----------------+----------+
| 2007 |        1 |            500 |           4000 |      151 |
| 2007 |        2 |           4000 |           6000 |      151 |
| 2007 |        3 |           6000 |          10475 |      151 |
| 2007 |        4 |          10475 |          25000 |      150 |
| 2008 |        1 |            500 |           5000 |      599 |
| 2008 |        2 |           5000 |           7500 |      598 |
| 2008 |        3 |           7500 |          11200 |      598 |
| 2008 |        4 |          11225 |          25000 |      598 |
| 2009 |        1 |           1000 |           5000 |     1321 |
| 2009 |        2 |           5000 |           8800 |     1320 |
| 2009 |        3 |           8800 |          14000 |     1320 |
| 2009 |        4 |          14000 |          25000 |     1320 |
| 2010 |        1 |           1000 |           5000 |     3135 |
| 2010 |        2 |           5000 |           9300 |     3134 |
| 2010 |        3 |           9300 |          15000 |     3134 |
| 2010 |        4 |          15000 |          25000 |     3134 |
| 2011 |        1 |           1000 |           6000 |     5431 |
| 2011 |        2 |           6000 |          10000 |     5430 |
| 2011 |        3 |          10000 |          16000 |     5430 |
| 2011 |        4 |          16000 |          35000 |     5430 |
| 2012 |        1 |           1000 |           7200 |    13342 |
| 2012 |        2 |           7200 |          12000 |    13342 |
| 2012 |        3 |          12000 |          18200 |    13342 |
| 2012 |        4 |          18200 |          35000 |    13341 |
| 2013 |        1 |           1000 |           8500 |    33704 |
| 2013 |        2 |           8500 |          13000 |    33704 |
| 2013 |        3 |          13000 |          20000 |    33703 |
| 2013 |        4 |          20000 |          35000 |    33703 |
+------+----------+----------------+----------------+----------+
28 rows in set (1.17 sec)

 
============================================================================================ 
PERCENT_RANK
select row_number() over (partition by year(issue_d) order by issue_d) row_in_year, 
       issue_d, 
       avg, 
       count,
       rank() over (partition by year(issue_d) order by count) rank_count, 
       percent_rank() over (partition by year(issue_d) order by count) percent_rank_count, 
       cume_dist() over (partition by year(issue_d) order by count) cume_dist_count
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+-------------+------------+------------+-------+------------+--------------------+-----------------+
| row_in_year | issue_d    | avg        | count | rank_count | percent_rank_count | cume_dist_count |
+-------------+------------+------------+-------+------------+--------------------+-----------------+
|           1 | 2007-06-01 |  3827.0833 |    24 |          1 |       0.0000000000 |    0.1428571429 |
|           2 | 2007-07-01 |  5528.9683 |    63 |          3 |       0.3333333333 |    0.4285714286 |
|           3 | 2007-08-01 |  6963.5135 |    74 |          4 |       0.5000000000 |    0.5714285714 |
|           4 | 2007-09-01 |  7036.7925 |    53 |          2 |       0.1666666667 |    0.2857142857 |
|           5 | 2007-10-01 |  7173.5714 |   105 |          5 |       0.6666666667 |    0.7142857143 |
|           6 | 2007-11-01 |  9005.8036 |   112 |          6 |       0.8333333333 |    0.8571428571 |
|           7 | 2007-12-01 | 10971.9477 |   172 |          7 |       1.0000000000 |    1.0000000000 |
|           1 | 2008-01-01 |  9593.4426 |   305 |         10 |       0.8181818182 |    0.8333333333 |
|           2 | 2008-02-01 |  9670.6699 |   306 |         11 |       0.9090909091 |    0.9166666667 |
|           3 | 2008-03-01 | 10323.5075 |   402 |         12 |       1.0000000000 |    1.0000000000 |
|           4 | 2008-04-01 |  9397.2008 |   259 |          9 |       0.7272727273 |    0.7500000000 |
|           5 | 2008-05-01 |  5468.6957 |   115 |          3 |       0.1818181818 |    0.2500000000 |
|           6 | 2008-06-01 |  5323.9919 |   124 |          5 |       0.3636363636 |    0.4166666667 |
|           7 | 2008-07-01 |  6074.2908 |   141 |          6 |       0.4545454545 |    0.5000000000 |
|           8 | 2008-08-01 |  5924.5000 |   100 |          2 |       0.0909090909 |    0.1666666667 |
|           9 | 2008-09-01 |  5573.2456 |    57 |          1 |       0.0000000000 |    0.0833333333 |
|          10 | 2008-10-01 |  7889.7541 |   122 |          4 |       0.2727272727 |    0.3333333333 |
|          11 | 2008-11-01 |  9879.9043 |   209 |          7 |       0.5454545455 |    0.5833333333 |
|          12 | 2008-12-01 | 10146.1462 |   253 |          8 |       0.6363636364 |    0.6666666667 |
|           1 | 2009-01-01 |  9182.6208 |   269 |          1 |       0.0000000000 |    0.0833333333 |
|           2 | 2009-02-01 |  8989.8179 |   302 |          2 |       0.0909090909 |    0.1666666667 |
|           3 | 2009-03-01 |  9448.4568 |   324 |          3 |       0.1818181818 |    0.2500000000 |
|           4 | 2009-04-01 |  9247.6727 |   333 |          4 |       0.2727272727 |    0.3333333333 |
|           5 | 2009-05-01 |  9591.3649 |   359 |          5 |       0.3636363636 |    0.4166666667 |
|           6 | 2009-06-01 |  8848.0296 |   406 |          6 |       0.4545454545 |    0.5000000000 |
|           7 | 2009-07-01 |  9431.0219 |   411 |          7 |       0.5454545455 |    0.5833333333 |
|           8 | 2009-08-01 |  9683.0717 |   446 |          8 |       0.6363636364 |    0.6666666667 |
|           9 | 2009-09-01 | 10073.4221 |   507 |          9 |       0.7272727273 |    0.7500000000 |
|          10 | 2009-10-01 | 10412.9967 |   604 |         10 |       0.8181818182 |    0.8333333333 |
|          11 | 2009-11-01 | 10345.7326 |   662 |         12 |       1.0000000000 |    1.0000000000 |
|          12 | 2009-12-01 | 10830.5091 |   658 |         11 |       0.9090909091 |    0.9166666667 |
|           1 | 2010-01-01 | 11157.0242 |   662 |          1 |       0.0000000000 |    0.0833333333 |
|           2 | 2010-02-01 | 10938.4164 |   682 |          2 |       0.0909090909 |    0.1666666667 |
|           3 | 2010-03-01 | 10464.6739 |   828 |          3 |       0.1818181818 |    0.2500000000 |
|           4 | 2010-04-01 | 10428.2621 |   912 |          4 |       0.2727272727 |    0.3333333333 |
|           5 | 2010-05-01 | 10726.1375 |   989 |          5 |       0.3636363636 |    0.4166666667 |
|           6 | 2010-06-01 | 10108.1900 |  1105 |          6 |       0.4545454545 |    0.5000000000 |
|           7 | 2010-07-01 |  9914.0365 |  1204 |          9 |       0.7272727273 |    0.7500000000 |
|           8 | 2010-08-01 | 10299.4681 |  1175 |          7 |       0.5454545455 |    0.5833333333 |
|           9 | 2010-09-01 | 10304.9622 |  1189 |          8 |       0.6363636364 |    0.6666666667 |
|          10 | 2010-10-01 | 10659.1924 |  1232 |         11 |       0.9090909091 |    0.9166666667 |
|          11 | 2010-11-01 | 11014.2770 |  1224 |         10 |       0.8181818182 |    0.8333333333 |
|          12 | 2010-12-01 | 10703.3708 |  1335 |         12 |       1.0000000000 |    1.0000000000 |
|           1 | 2011-01-01 | 10742.4457 |  1380 |          2 |       0.0909090909 |    0.1666666667 |
|           2 | 2011-02-01 | 11249.0562 |  1298 |          1 |       0.0000000000 |    0.0833333333 |
|           3 | 2011-03-01 | 11441.5228 |  1448 |          3 |       0.1818181818 |    0.2500000000 |
|           4 | 2011-04-01 | 11223.3365 |  1563 |          4 |       0.2727272727 |    0.3333333333 |
|           5 | 2011-05-01 | 11342.6937 |  1704 |          5 |       0.3636363636 |    0.4166666667 |
|           6 | 2011-06-01 | 11411.5531 |  1835 |          6 |       0.4545454545 |    0.5000000000 |
|           7 | 2011-07-01 | 11380.0533 |  1875 |          7 |       0.5454545455 |    0.5833333333 |
|           8 | 2011-08-01 | 12020.4369 |  1934 |          8 |       0.6363636364 |    0.6666666667 |
|           9 | 2011-09-01 | 12500.0726 |  2067 |          9 |       0.7272727273 |    0.7500000000 |
|          10 | 2011-10-01 | 12975.7082 |  2118 |         10 |       0.8181818182 |    0.8333333333 |
|          11 | 2011-11-01 | 12693.8172 |  2232 |         11 |       0.9090909091 |    0.9166666667 |
|          12 | 2011-12-01 | 13957.8738 |  2267 |         12 |       1.0000000000 |    1.0000000000 |
|           1 | 2012-01-01 | 13151.6045 |  2602 |          2 |       0.0909090909 |    0.1666666667 |
|           2 | 2012-02-01 | 14085.2246 |  2560 |          1 |       0.0000000000 |    0.0833333333 |
|           3 | 2012-03-01 | 13567.7076 |  2914 |          3 |       0.1818181818 |    0.2500000000 |
|           4 | 2012-04-01 | 13018.9241 |  3230 |          4 |       0.2727272727 |    0.3333333333 |
|           5 | 2012-05-01 | 13262.0074 |  3400 |          5 |       0.3636363636 |    0.4166666667 |
|           6 | 2012-06-01 | 13158.0495 |  3817 |          6 |       0.4545454545 |    0.5000000000 |
|           7 | 2012-07-01 | 13031.0190 |  4627 |          7 |       0.5454545455 |    0.5833333333 |
|           8 | 2012-08-01 | 12932.0262 |  5419 |          8 |       0.6363636364 |    0.6666666667 |
|           9 | 2012-09-01 | 12654.4685 |  6087 |         10 |       0.8181818182 |    0.8333333333 |
|          10 | 2012-10-01 | 13099.4931 |  6263 |         11 |       0.9090909091 |    0.9166666667 |
|          11 | 2012-11-01 | 13741.2018 |  6382 |         12 |       1.0000000000 |    1.0000000000 |
|          12 | 2012-12-01 | 15511.1194 |  6066 |          9 |       0.7272727273 |    0.7500000000 |
|           1 | 2013-01-01 | 15290.2175 |  6872 |          1 |       0.0000000000 |    0.0833333333 |
|           2 | 2013-02-01 | 15893.5822 |  7561 |          2 |       0.0909090909 |    0.1666666667 |
|           3 | 2013-03-01 | 15428.9254 |  8273 |          3 |       0.1818181818 |    0.2500000000 |
|           4 | 2013-04-01 | 14876.9270 |  9419 |          4 |       0.2727272727 |    0.3333333333 |
|           5 | 2013-05-01 | 14303.0411 | 10350 |          5 |       0.3636363636 |    0.4166666667 |
|           6 | 2013-06-01 | 14502.5576 | 10899 |          6 |       0.4545454545 |    0.5000000000 |
|           7 | 2013-07-01 | 14338.9442 | 11910 |          7 |       0.5454545455 |    0.5833333333 |
|           8 | 2013-08-01 | 14204.8820 | 12674 |          8 |       0.6363636364 |    0.6666666667 |
|           9 | 2013-09-01 | 14469.1711 | 12987 |          9 |       0.7272727273 |    0.7500000000 |
|          10 | 2013-10-01 | 14493.0232 | 14129 |         10 |       0.8181818182 |    0.8333333333 |
|          11 | 2013-11-01 | 14673.4188 | 14720 |         11 |       0.9090909091 |    0.9166666667 |
|          12 | 2013-12-01 | 14924.4424 | 15020 |         12 |       1.0000000000 |    1.0000000000 |
+-------------+------------+------------+-------+------------+--------------------+-----------------+
79 rows in set (1.342 sec)


 
============================================================================================ 
PERCENTILE_CONT

select distinct *       
from (select year, 
             percentile_cont(0.25) within group (order by loan_amnt) over (partition by year) as perc25, 
             percentile_cont(0.50) within group (order by loan_amnt) over (partition by year) as perc50, 
             percentile_cont(0.75) within group (order by loan_amnt) over (partition by year) as perc75, 
             percentile_cont(1.00) within group (order by loan_amnt) over (partition by year) as perc100 
      from loanstats) t 
order by t.year;
+------+-----------------+------------------+------------------+------------------+
| year | perc25          | perc50           | perc75           | perc100          |
+------+-----------------+------------------+------------------+------------------+
| 2007 | 4000.0000000000 |  6000.0000000000 | 10475.0000000000 | 25000.0000000000 |
| 2008 | 5000.0000000000 |  7500.0000000000 | 11200.0000000000 | 25000.0000000000 |
| 2009 | 5000.0000000000 |  8800.0000000000 | 14000.0000000000 | 25000.0000000000 |
| 2010 | 5000.0000000000 |  9300.0000000000 | 15000.0000000000 | 25000.0000000000 |
| 2011 | 6000.0000000000 | 10000.0000000000 | 16000.0000000000 | 35000.0000000000 |
| 2012 | 7200.0000000000 | 12000.0000000000 | 18200.0000000000 | 35000.0000000000 |
| 2013 | 8500.0000000000 | 13000.0000000000 | 20000.0000000000 | 35000.0000000000 |
+------+-----------------+------------------+------------------+------------------+
7 rows in set (0.833 sec)
    
 
============================================================================================ 
PERCENTILE_DISC

select distinct *       
from (select year, 
             percentile_disc(0.25) within group (order by loan_amnt) over (partition by year) as perc25, 
             percentile_disc(0.50) within group (order by loan_amnt) over (partition by year) as perc50, 
             percentile_disc(0.75) within group (order by loan_amnt) over (partition by year) as perc75, 
             percentile_disc(1.00) within group (order by loan_amnt) over (partition by year) as perc100 
      from loanstats) t 
order by t.year;
+------+--------+--------+--------+---------+
| year | perc25 | perc50 | perc75 | perc100 |
+------+--------+--------+--------+---------+
| 2007 |   4000 |   6000 |  10475 |   25000 |
| 2008 |   5000 |   7500 |  11200 |   25000 |
| 2009 |   5000 |   8800 |  14000 |   25000 |
| 2010 |   5000 |   9300 |  15000 |   25000 |
| 2011 |   6000 |  10000 |  16000 |   35000 |
| 2012 |   7200 |  12000 |  18200 |   35000 |
| 2013 |   8500 |  13000 |  20000 |   35000 |
+------+--------+--------+--------+---------+
7 rows in set (0.715 sec)

 
============================================================================================ 
RANK

select issue_d, 
       avg, 
       rank() over (order by avg) rankavg, 
       count 
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by rankavg;
+------------+------------+---------+-------+
| issue_d    | avg        | rankavg | count |
+------------+------------+---------+-------+
| 2007-06-01 |  3827.0833 |       1 |    24 |
| 2008-06-01 |  5323.9919 |       2 |   124 |
| 2008-05-01 |  5468.6957 |       3 |   115 |
| 2007-07-01 |  5528.9683 |       4 |    63 |
| 2008-09-01 |  5573.2456 |       5 |    57 |
| 2008-08-01 |  5924.5000 |       6 |   100 |
| 2008-07-01 |  6074.2908 |       7 |   141 |
| 2007-08-01 |  6963.5135 |       8 |    74 |
| 2007-09-01 |  7036.7925 |       9 |    53 |
| 2007-10-01 |  7173.5714 |      10 |   105 |
| 2008-10-01 |  7889.7541 |      11 |   122 |
| 2009-06-01 |  8848.0296 |      12 |   406 |
| 2009-02-01 |  8989.8179 |      13 |   302 |
| 2007-11-01 |  9005.8036 |      14 |   112 |
| 2009-01-01 |  9182.6208 |      15 |   269 |
| 2009-04-01 |  9247.6727 |      16 |   333 |
| 2008-04-01 |  9397.2008 |      17 |   259 |
| 2009-07-01 |  9431.0219 |      18 |   411 |
| 2009-03-01 |  9448.4568 |      19 |   324 |
| 2009-05-01 |  9591.3649 |      20 |   359 |
| 2008-01-01 |  9593.4426 |      21 |   305 |
| 2008-02-01 |  9670.6699 |      22 |   306 |
| 2009-08-01 |  9683.0717 |      23 |   446 |
| 2008-11-01 |  9879.9043 |      24 |   209 |
| 2010-07-01 |  9914.0365 |      25 |  1204 |
| 2009-09-01 | 10073.4221 |      26 |   507 |
| 2010-06-01 | 10108.1900 |      27 |  1105 |
| 2008-12-01 | 10146.1462 |      28 |   253 |
| 2010-08-01 | 10299.4681 |      29 |  1175 |
| 2010-09-01 | 10304.9622 |      30 |  1189 |
| 2008-03-01 | 10323.5075 |      31 |   402 |
| 2009-11-01 | 10345.7326 |      32 |   662 |
| 2009-10-01 | 10412.9967 |      33 |   604 |
| 2010-04-01 | 10428.2621 |      34 |   912 |
| 2010-03-01 | 10464.6739 |      35 |   828 |
| 2010-10-01 | 10659.1924 |      36 |  1232 |
| 2010-12-01 | 10703.3708 |      37 |  1335 |
| 2010-05-01 | 10726.1375 |      38 |   989 |
| 2011-01-01 | 10742.4457 |      39 |  1380 |
| 2009-12-01 | 10830.5091 |      40 |   658 |
| 2010-02-01 | 10938.4164 |      41 |   682 |
| 2007-12-01 | 10971.9477 |      42 |   172 |
| 2010-11-01 | 11014.2770 |      43 |  1224 |
| 2010-01-01 | 11157.0242 |      44 |   662 |
| 2011-04-01 | 11223.3365 |      45 |  1563 |
| 2011-02-01 | 11249.0562 |      46 |  1298 |
| 2011-05-01 | 11342.6937 |      47 |  1704 |
| 2011-07-01 | 11380.0533 |      48 |  1875 |
| 2011-06-01 | 11411.5531 |      49 |  1835 |
| 2011-03-01 | 11441.5228 |      50 |  1448 |
| 2011-08-01 | 12020.4369 |      51 |  1934 |
| 2011-09-01 | 12500.0726 |      52 |  2067 |
| 2012-09-01 | 12654.4685 |      53 |  6087 |
| 2011-11-01 | 12693.8172 |      54 |  2232 |
| 2012-08-01 | 12932.0262 |      55 |  5419 |
| 2011-10-01 | 12975.7082 |      56 |  2118 |
| 2012-04-01 | 13018.9241 |      57 |  3230 |
| 2012-07-01 | 13031.0190 |      58 |  4627 |
| 2012-10-01 | 13099.4931 |      59 |  6263 |
| 2012-01-01 | 13151.6045 |      60 |  2602 |
| 2012-06-01 | 13158.0495 |      61 |  3817 |
| 2012-05-01 | 13262.0074 |      62 |  3400 |
| 2012-03-01 | 13567.7076 |      63 |  2914 |
| 2012-11-01 | 13741.2018 |      64 |  6382 |
| 2011-12-01 | 13957.8738 |      65 |  2267 |
| 2012-02-01 | 14085.2246 |      66 |  2560 |
| 2013-08-01 | 14204.8820 |      67 | 12674 |
| 2013-05-01 | 14303.0411 |      68 | 10350 |
| 2013-07-01 | 14338.9442 |      69 | 11910 |
| 2013-09-01 | 14469.1711 |      70 | 12987 |
| 2013-10-01 | 14493.0232 |      71 | 14129 |
| 2013-06-01 | 14502.5576 |      72 | 10899 |
| 2013-11-01 | 14673.4188 |      73 | 14720 |
| 2013-04-01 | 14876.9270 |      74 |  9419 |
| 2013-12-01 | 14924.4424 |      75 | 15020 |
| 2013-01-01 | 15290.2175 |      76 |  6872 |
| 2013-03-01 | 15428.9254 |      77 |  8273 |
| 2012-12-01 | 15511.1194 |      78 |  6066 |
| 2013-02-01 | 15893.5822 |      79 |  7561 |
+------------+------------+---------+-------+
79 rows in set (1.331 sec)


 
============================================================================================ 
ROW_NUMBER 

select row_number() over (partition by year(issue_d) order by issue_d) row_in_year, 
       issue_d, 
       avg, 
       count,
       rank() over (order by count) rank_count_total, 
       rank() over (partition by year(issue_d) order by count) rank_count_year
from (select distinct * 
      from (select issue_d, 
                   avg(loan_amnt) over (partition by issue_d) avg, 
                   count(*) over (partition by issue_d) count 
            from loanstats 
            order by issue_d
           ) tt
      ) t
order by issue_d;
+-------------+------------+------------+-------+------------------+-----------------+
| row_in_year | issue_d    | avg        | count | rank_count_total | rank_count_year |
+-------------+------------+------------+-------+------------------+-----------------+
|           1 | 2007-06-01 |  3827.0833 |    24 |                1 |               1 |
|           2 | 2007-07-01 |  5528.9683 |    63 |                4 |               3 |
|           3 | 2007-08-01 |  6963.5135 |    74 |                5 |               4 |
|           4 | 2007-09-01 |  7036.7925 |    53 |                2 |               2 |
|           5 | 2007-10-01 |  7173.5714 |   105 |                7 |               5 |
|           6 | 2007-11-01 |  9005.8036 |   112 |                8 |               6 |
|           7 | 2007-12-01 | 10971.9477 |   172 |               13 |               7 |
|           1 | 2008-01-01 |  9593.4426 |   305 |               19 |              10 |
|           2 | 2008-02-01 |  9670.6699 |   306 |               20 |              11 |
|           3 | 2008-03-01 | 10323.5075 |   402 |               24 |              12 |
|           4 | 2008-04-01 |  9397.2008 |   259 |               16 |               9 |
|           5 | 2008-05-01 |  5468.6957 |   115 |                9 |               3 |
|           6 | 2008-06-01 |  5323.9919 |   124 |               11 |               5 |
|           7 | 2008-07-01 |  6074.2908 |   141 |               12 |               6 |
|           8 | 2008-08-01 |  5924.5000 |   100 |                6 |               2 |
|           9 | 2008-09-01 |  5573.2456 |    57 |                3 |               1 |
|          10 | 2008-10-01 |  7889.7541 |   122 |               10 |               4 |
|          11 | 2008-11-01 |  9879.9043 |   209 |               14 |               7 |
|          12 | 2008-12-01 | 10146.1462 |   253 |               15 |               8 |
|           1 | 2009-01-01 |  9182.6208 |   269 |               17 |               1 |
|           2 | 2009-02-01 |  8989.8179 |   302 |               18 |               2 |
|           3 | 2009-03-01 |  9448.4568 |   324 |               21 |               3 |
|           4 | 2009-04-01 |  9247.6727 |   333 |               22 |               4 |
|           5 | 2009-05-01 |  9591.3649 |   359 |               23 |               5 |
|           6 | 2009-06-01 |  8848.0296 |   406 |               25 |               6 |
|           7 | 2009-07-01 |  9431.0219 |   411 |               26 |               7 |
|           8 | 2009-08-01 |  9683.0717 |   446 |               27 |               8 |
|           9 | 2009-09-01 | 10073.4221 |   507 |               28 |               9 |
|          10 | 2009-10-01 | 10412.9967 |   604 |               29 |              10 |
|          11 | 2009-11-01 | 10345.7326 |   662 |               31 |              12 |
|          12 | 2009-12-01 | 10830.5091 |   658 |               30 |              11 |
|           1 | 2010-01-01 | 11157.0242 |   662 |               31 |               1 |
|           2 | 2010-02-01 | 10938.4164 |   682 |               33 |               2 |
|           3 | 2010-03-01 | 10464.6739 |   828 |               34 |               3 |
|           4 | 2010-04-01 | 10428.2621 |   912 |               35 |               4 |
|           5 | 2010-05-01 | 10726.1375 |   989 |               36 |               5 |
|           6 | 2010-06-01 | 10108.1900 |  1105 |               37 |               6 |
|           7 | 2010-07-01 |  9914.0365 |  1204 |               40 |               9 |
|           8 | 2010-08-01 | 10299.4681 |  1175 |               38 |               7 |
|           9 | 2010-09-01 | 10304.9622 |  1189 |               39 |               8 |
|          10 | 2010-10-01 | 10659.1924 |  1232 |               42 |              11 |
|          11 | 2010-11-01 | 11014.2770 |  1224 |               41 |              10 |
|          12 | 2010-12-01 | 10703.3708 |  1335 |               44 |              12 |
|           1 | 2011-01-01 | 10742.4457 |  1380 |               45 |               2 |
|           2 | 2011-02-01 | 11249.0562 |  1298 |               43 |               1 |
|           3 | 2011-03-01 | 11441.5228 |  1448 |               46 |               3 |
|           4 | 2011-04-01 | 11223.3365 |  1563 |               47 |               4 |
|           5 | 2011-05-01 | 11342.6937 |  1704 |               48 |               5 |
|           6 | 2011-06-01 | 11411.5531 |  1835 |               49 |               6 |
|           7 | 2011-07-01 | 11380.0533 |  1875 |               50 |               7 |
|           8 | 2011-08-01 | 12020.4369 |  1934 |               51 |               8 |
|           9 | 2011-09-01 | 12500.0726 |  2067 |               52 |               9 |
|          10 | 2011-10-01 | 12975.7082 |  2118 |               53 |              10 |
|          11 | 2011-11-01 | 12693.8172 |  2232 |               54 |              11 |
|          12 | 2011-12-01 | 13957.8738 |  2267 |               55 |              12 |
|           1 | 2012-01-01 | 13151.6045 |  2602 |               57 |               2 |
|           2 | 2012-02-01 | 14085.2246 |  2560 |               56 |               1 |
|           3 | 2012-03-01 | 13567.7076 |  2914 |               58 |               3 |
|           4 | 2012-04-01 | 13018.9241 |  3230 |               59 |               4 |
|           5 | 2012-05-01 | 13262.0074 |  3400 |               60 |               5 |
|           6 | 2012-06-01 | 13158.0495 |  3817 |               61 |               6 |
|           7 | 2012-07-01 | 13031.0190 |  4627 |               62 |               7 |
|           8 | 2012-08-01 | 12932.0262 |  5419 |               63 |               8 |
|           9 | 2012-09-01 | 12654.4685 |  6087 |               65 |              10 |
|          10 | 2012-10-01 | 13099.4931 |  6263 |               66 |              11 |
|          11 | 2012-11-01 | 13741.2018 |  6382 |               67 |              12 |
|          12 | 2012-12-01 | 15511.1194 |  6066 |               64 |               9 |
|           1 | 2013-01-01 | 15290.2175 |  6872 |               68 |               1 |
|           2 | 2013-02-01 | 15893.5822 |  7561 |               69 |               2 |
|           3 | 2013-03-01 | 15428.9254 |  8273 |               70 |               3 |
|           4 | 2013-04-01 | 14876.9270 |  9419 |               71 |               4 |
|           5 | 2013-05-01 | 14303.0411 | 10350 |               72 |               5 |
|           6 | 2013-06-01 | 14502.5576 | 10899 |               73 |               6 |
|           7 | 2013-07-01 | 14338.9442 | 11910 |               74 |               7 |
|           8 | 2013-08-01 | 14204.8820 | 12674 |               75 |               8 |
|           9 | 2013-09-01 | 14469.1711 | 12987 |               76 |               9 |
|          10 | 2013-10-01 | 14493.0232 | 14129 |               77 |              10 |
|          11 | 2013-11-01 | 14673.4188 | 14720 |               78 |              11 |
|          12 | 2013-12-01 | 14924.4424 | 15020 |               79 |              12 |
+-------------+------------+------------+-------+------------------+-----------------+
79 rows in set (1.330 sec)

